<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by perltidy on Sun Mar  9 08:18:46 2014 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Prefs.pm</title>
<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #FFFFFF;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
</head>
<body>
<a name="-top-"></a>
<h1>Prefs.pm</h1>
<hr />
<!-- contents of filename: Prefs.pm -->
<pre>
<span class="c"># ClamTk, copyright (C) 2004-2014 Dave M</span>
<span class="c">#</span>
<span class="c"># This file is part of ClamTk (http://code.google.com/p/clamtk/).</span>
<span class="c">#</span>
<span class="c"># ClamTk is free software; you can redistribute it and/or modify it</span>
<span class="c"># under the terms of either:</span>
<span class="c">#</span>
<span class="c"># a) the GNU General Public License as published by the Free Software</span>
<span class="c"># Foundation; either version 1, or (at your option) any later version, or</span>
<span class="c">#</span>
<span class="c"># b) the &quot;Artistic License&quot;.</span>
<a name="package-ClamTk::Prefs-"></a><span class="k">package </span><span class="i">ClamTk::Prefs</span><span class="sc">;</span>

<span class="c"># use strict;</span>
<span class="c"># use warnings;</span>
<span class="i">$|</span> = <span class="n">1</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">Digest::MD5</span> <span class="q">&#39;md5_hex&#39;</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">File::Path</span> <span class="q">&#39;mkpath&#39;</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">Locale::gettext</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">POSIX</span> <span class="q">&#39;locale_h&#39;</span><span class="sc">;</span>

<a name="structure-"></a><span class="k">sub </span><span class="m">structure</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$paths</span> = <span class="w">ClamTk::App</span><span class="w">-&gt;get_path</span><span class="s">(</span> <span class="q">&#39;all&#39;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># Ensure default paths/files exist.</span>
    <span class="c"># If they do, ensure they have the proper permissions.</span>
    <span class="c"># The default Fedora umask for users is 0002,</span>
    <span class="c"># while Ubuntu&#39;s is 0022... sigh.</span>
    <span class="c"># I&#39;m going to assume that it&#39;s one or the other.</span>
    <span class="c"># my $umask = sprintf(&quot;%04o&quot;, umask());</span>
    <span class="k">my</span> <span class="i">$mask</span> = <span class="s">(</span> <span class="k">umask</span><span class="s">(</span><span class="s">)</span> == <span class="n">2</span> <span class="s">)</span> ? <span class="q">&#39;0775&#39;</span> <span class="co">:</span> <span class="q">&#39;0755&#39;</span><span class="sc">;</span>

    <span class="c"># This is /home/user/.clamtk/viruses,</span>
    <span class="c"># used for the quarantine directory</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">-d</span> <span class="i">$paths</span>-&gt;{ <span class="w">viruses</span> } <span class="s">)</span> <span class="s">{</span>
        <span class="k">eval</span> <span class="s">{</span> <span class="i">mkpath</span><span class="s">(</span> <span class="i">$paths</span>-&gt;{ <span class="w">viruses</span> }<span class="cm">,</span> <span class="s">{</span> <span class="w">mode</span> <span class="cm">=&gt;</span> <span class="k">oct</span><span class="s">(</span> <span class="i">$mask</span> <span class="s">)</span> <span class="s">}</span> <span class="s">)</span> <span class="s">}</span><span class="sc">;</span>
        <span class="k">warn</span> <span class="i">$@</span>  <span class="k">if</span> <span class="s">(</span> <span class="i">$@</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">0</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$@</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="c"># Ensure the permissions are correct</span>
        <span class="k">chmod</span> <span class="k">oct</span><span class="s">(</span> <span class="i">$mask</span> <span class="s">)</span><span class="cm">,</span> <span class="i">$paths</span>-&gt;{ <span class="w">viruses</span> }<span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># This is /home/user/.clamtk/history,</span>
    <span class="c"># which holds records of scans</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">-d</span> <span class="i">$paths</span>-&gt;{ <span class="w">history</span> } <span class="s">)</span> <span class="s">{</span>
        <span class="k">eval</span> <span class="s">{</span> <span class="i">mkpath</span><span class="s">(</span> <span class="i">$paths</span>-&gt;{ <span class="w">history</span> }<span class="cm">,</span> <span class="s">{</span> <span class="w">mode</span> <span class="cm">=&gt;</span> <span class="k">oct</span><span class="s">(</span> <span class="i">$mask</span> <span class="s">)</span> <span class="s">}</span> <span class="s">)</span> <span class="s">}</span><span class="sc">;</span>
        <span class="k">warn</span> <span class="i">$@</span>  <span class="k">if</span> <span class="s">(</span> <span class="i">$@</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">0</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$@</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="c"># Ensure the permissions are correct</span>
        <span class="k">chmod</span> <span class="k">oct</span><span class="s">(</span> <span class="i">$mask</span> <span class="s">)</span><span class="cm">,</span> <span class="i">$paths</span>-&gt;{ <span class="w">history</span> }<span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># The path /home/user/.clamtk/db stores signatures</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">-d</span> <span class="i">$paths</span>-&gt;{ <span class="w">db</span> } <span class="s">)</span> <span class="s">{</span>
        <span class="k">eval</span> <span class="s">{</span> <span class="i">mkpath</span><span class="s">(</span> <span class="i">$paths</span>-&gt;{ <span class="w">db</span> }<span class="cm">,</span> <span class="s">{</span> <span class="w">mode</span> <span class="cm">=&gt;</span> <span class="k">oct</span><span class="s">(</span> <span class="i">$mask</span> <span class="s">)</span> <span class="s">}</span> <span class="s">)</span> <span class="s">}</span><span class="sc">;</span>
        <span class="k">warn</span> <span class="i">$@</span>  <span class="k">if</span> <span class="i">$@</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">0</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$@</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="c"># Ensure the permissions are correct</span>
        <span class="k">chmod</span> <span class="k">oct</span><span class="s">(</span> <span class="i">$mask</span> <span class="s">)</span><span class="cm">,</span> <span class="i">$paths</span>-&gt;{ <span class="w">db</span> }<span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># This is /home/user/.clamtk/prefs,</span>
    <span class="c"># a custom INI-style file.</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">-e</span> <span class="i">$paths</span>-&gt;{ <span class="w">prefs</span> } <span class="s">)</span> <span class="s">{</span>
        <span class="k">warn</span> <span class="q">&quot;note: (re)creating prefs file.\n&quot;</span><span class="sc">;</span>
        <span class="k">open</span><span class="s">(</span> <span class="k">my</span> <span class="i">$F</span><span class="cm">,</span> <span class="q">&#39;&gt;:encoding(UTF-8)&#39;</span><span class="cm">,</span> <span class="i">$paths</span>-&gt;{ <span class="w">prefs</span> } <span class="s">)</span>
            <span class="k">or</span> <span class="k">do</span> <span class="s">{</span>
            <span class="k">warn</span> <span class="q">&quot;Unable to create preferences! $!\n&quot;</span><span class="sc">;</span>
            <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
            <span class="s">}</span><span class="sc">;</span>
        <span class="k">close</span><span class="s">(</span> <span class="i">$F</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">eval</span> <span class="s">{</span> <span class="i">custom_prefs</span><span class="s">(</span><span class="s">)</span> <span class="s">}</span><span class="sc">;</span>
        <span class="k">warn</span> <span class="i">$@</span>  <span class="k">if</span> <span class="s">(</span> <span class="i">$@</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">0</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$@</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># This is /home/user/.clamtk/submit.</span>
    <span class="c"># This was used for submitting to ClamAV;</span>
    <span class="c"># we&#39;re reusing the directory structure</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">-d</span> <span class="i">$paths</span>-&gt;{ <span class="w">submit</span> } <span class="s">)</span> <span class="s">{</span>
        <span class="k">eval</span> <span class="s">{</span> <span class="i">mkpath</span><span class="s">(</span> <span class="i">$paths</span>-&gt;{ <span class="w">submit</span> }<span class="cm">,</span> <span class="s">{</span> <span class="w">mode</span> <span class="cm">=&gt;</span> <span class="k">oct</span><span class="s">(</span> <span class="i">$mask</span> <span class="s">)</span> <span class="s">}</span> <span class="s">)</span> <span class="s">}</span><span class="sc">;</span>
        <span class="k">warn</span> <span class="i">$@</span>  <span class="k">if</span> <span class="i">$@</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">0</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$@</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="c"># Ensure the permissions are correct</span>
        <span class="k">chmod</span> <span class="k">oct</span><span class="s">(</span> <span class="i">$mask</span> <span class="s">)</span><span class="cm">,</span> <span class="i">$paths</span>-&gt;{ <span class="w">submit</span> }<span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># This is /home/user/.clamtk/submit/previous_submissions,</span>
    <span class="c"># a csv file.</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">-e</span> <span class="i">$paths</span>-&gt;{ <span class="w">previous_submissions</span> } <span class="s">)</span> <span class="s">{</span>
        <span class="k">open</span><span class="s">(</span> <span class="k">my</span> <span class="i">$F</span><span class="cm">,</span> <span class="q">&#39;&gt;:encoding(UTF-8)&#39;</span><span class="cm">,</span> <span class="i">$paths</span>-&gt;{ <span class="w">previous_submissions</span> } <span class="s">)</span>
            <span class="k">or</span> <span class="k">do</span> <span class="s">{</span>
            <span class="k">warn</span> <span class="q">&quot;Unable to create previous_submissions! $!\n&quot;</span><span class="sc">;</span>
            <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
            <span class="s">}</span><span class="sc">;</span>
        <span class="k">close</span><span class="s">(</span> <span class="i">$F</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># This is /home/user/.clamtk/submit/virustotal_links,</span>
    <span class="c"># a csv file.</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">-e</span> <span class="i">$paths</span>-&gt;{ <span class="w">virustotal_links</span> } <span class="s">)</span> <span class="s">{</span>
        <span class="k">open</span><span class="s">(</span> <span class="k">my</span> <span class="i">$F</span><span class="cm">,</span> <span class="q">&#39;&gt;:encoding(UTF-8)&#39;</span><span class="cm">,</span> <span class="i">$paths</span>-&gt;{ <span class="w">virustotal_links</span> } <span class="s">)</span>
            <span class="k">or</span> <span class="k">do</span> <span class="s">{</span>
            <span class="k">warn</span> <span class="q">&quot;Unable to create virustotal_links! $!\n&quot;</span><span class="sc">;</span>
            <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
            <span class="s">}</span><span class="sc">;</span>
        <span class="k">close</span><span class="s">(</span> <span class="i">$F</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># This is /home/user/.clamtk/restore, which holds</span>
    <span class="c"># information for putting back false positives</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">-e</span> <span class="i">$paths</span>-&gt;{ <span class="w">restore</span> } <span class="s">)</span> <span class="s">{</span>
        <span class="k">warn</span> <span class="q">&quot;restore does not exist; re-creating it\n&quot;</span><span class="sc">;</span>
        <span class="k">open</span><span class="s">(</span> <span class="k">my</span> <span class="i">$F</span><span class="cm">,</span> <span class="q">&#39;&gt;:encoding(UTF-8)&#39;</span><span class="cm">,</span> <span class="i">$paths</span>-&gt;{ <span class="w">restore</span> } <span class="s">)</span>
            <span class="k">or</span> <span class="k">do</span> <span class="s">{</span>
            <span class="k">warn</span> <span class="q">&quot;Unable to create restore file! $!\n&quot;</span><span class="sc">;</span>
            <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
            <span class="s">}</span><span class="sc">;</span>
        <span class="k">close</span><span class="s">(</span> <span class="i">$F</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>

<a name="custom_prefs-"></a><span class="k">sub </span><span class="m">custom_prefs</span> <span class="s">{</span>
    <span class="c"># ensure prefs have normalized variables:</span>
    <span class="k">my</span> <span class="i">%pkg</span><span class="sc">;</span>
    <span class="c"># Get the user&#39;s current prefs</span>
    <span class="k">my</span> <span class="i">$paths</span> = <span class="w">ClamTk::App</span><span class="w">-&gt;get_path</span><span class="s">(</span> <span class="q">&#39;prefs&#39;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">open</span><span class="s">(</span> <span class="k">my</span> <span class="i">$F</span><span class="cm">,</span> <span class="q">&#39;&lt;:encoding(UTF-8)&#39;</span><span class="cm">,</span> <span class="i">$paths</span> <span class="s">)</span>
        <span class="k">or</span> <span class="k">do</span> <span class="s">{</span>
        <span class="k">warn</span> <span class="q">&quot;Unable to read preferences! $!\n&quot;</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span><span class="sc">;</span>

    <span class="k">while</span> <span class="s">(</span> <span class="q">&lt;$F&gt;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$k</span><span class="cm">,</span> <span class="i">$v</span> <span class="s">)</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/=/</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">chomp</span><span class="s">(</span> <span class="i">$v</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$pkg</span>{ <span class="i">$k</span> } = <span class="i">$v</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">close</span><span class="s">(</span> <span class="i">$F</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># If the preferences aren&#39;t already set,</span>
    <span class="c"># use &#39;shared&#39; by default. This makes it work out of the box.</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">exists</span> <span class="i">$pkg</span>{ <span class="w">Update</span> } <span class="s">)</span> <span class="s">{</span>
        <span class="i">$pkg</span>{ <span class="w">Update</span> } = <span class="q">&#39;shared&#39;</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$pkg</span>{ <span class="w">Update</span> } !~ <span class="q">/shared|single/</span> <span class="s">)</span> <span class="s">{</span>
        <span class="c"># If it&#39;s set to &#39;shared&#39; or &#39;single&#39;, leave it alone.</span>
        <span class="c"># Otherwise, look for system signatures</span>
        <span class="i">$pkg</span>{ <span class="w">Update</span> } = <span class="q">&#39;shared&#39;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># The proxy is off by default</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">exists</span> <span class="i">$pkg</span>{ <span class="w">HTTPProxy</span> } <span class="s">)</span> <span class="s">{</span>
        <span class="i">$pkg</span>{ <span class="w">HTTPProxy</span> } = <span class="n">0</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># The whitelist is off by default</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">exists</span> <span class="i">$pkg</span>{ <span class="w">Whitelist</span> } <span class="s">)</span> <span class="s">{</span>
        <span class="i">$pkg</span>{ <span class="w">Whitelist</span> } = <span class="q">&#39;&#39;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># Date of last infected file</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">exists</span> <span class="i">$pkg</span>{ <span class="w">LastInfection</span> } <span class="s">)</span> <span class="s">{</span>
        <span class="i">$pkg</span>{ <span class="w">LastInfection</span> } = <span class="i">_</span><span class="s">(</span> <span class="q">&#39;Never&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># ScanHidden: Scan files beginning with a dot</span>
    <span class="c"># SizeLimit: Scan files larger than 20MB</span>
    <span class="c"># Thorough: Scan files for PUA</span>
    <span class="c"># Recursive: Scan all files/directories within a directory</span>
    <span class="c"># Mounted: Scan gvfs and related directories</span>
    <span class="k">for</span> <span class="k">my</span> <span class="i">$o</span> <span class="s">(</span>
        <span class="q">qw{ScanHidden SizeLimit</span>
        <span class="q">Thorough Recursive Mounted}</span>
        <span class="s">)</span>
    <span class="s">{</span>
        <span class="c"># off by default</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="k">exists</span> <span class="i">$pkg</span>{ <span class="i">$o</span> } <span class="s">)</span> <span class="s">{</span>
            <span class="i">$pkg</span>{ <span class="i">$o</span> } = <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c"># GUICheck: Check for GUI updates</span>
    <span class="c"># TruncateLog: Shorten freshclam log</span>
    <span class="c"># DupeDB: Delete duplicate signature dbs</span>
    <span class="k">for</span> <span class="k">my</span> <span class="i">$p</span> <span class="s">(</span> <span class="q">qw{GUICheck TruncateLog DupeDB }</span> <span class="s">)</span> <span class="s">{</span>
        <span class="c"># on by default</span>
        <span class="k">if</span> <span class="s">(</span> !<span class="k">exists</span> <span class="i">$pkg</span>{ <span class="i">$p</span> } <span class="s">)</span> <span class="s">{</span>
            <span class="i">$pkg</span>{ <span class="i">$p</span> } = <span class="n">1</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c"># Single click or double click in the main iconview.</span>
    <span class="c"># Since we started with double, stick with it by</span>
    <span class="c"># default for less aggravation</span>
    <span class="c"># 1 = single, 2 = double</span>
    <span class="c"># Clickings = short for Click Settings. I think.</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">exists</span> <span class="i">$pkg</span>{ <span class="w">Clickings</span> } <span class="s">)</span> <span class="s">{</span>
        <span class="i">$pkg</span>{ <span class="w">Clickings</span> } = <span class="n">2</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="i">write_all</span><span class="s">(</span> <span class="i">%pkg</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<a name="get_all_prefs-"></a><span class="k">sub </span><span class="m">get_all_prefs</span> <span class="s">{</span>
    <span class="c"># Sometimes it&#39;s useful to have all</span>
    <span class="c"># the preferences rather than just one.</span>
    <span class="k">my</span> <span class="i">%pkg</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$paths</span> = <span class="w">ClamTk::App</span><span class="w">-&gt;get_path</span><span class="s">(</span> <span class="q">&#39;prefs&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">open</span><span class="s">(</span> <span class="k">my</span> <span class="i">$F</span><span class="cm">,</span> <span class="q">&#39;&lt;:encoding(UTF-8)&#39;</span><span class="cm">,</span> <span class="i">$paths</span> <span class="s">)</span>
        <span class="k">or</span> <span class="k">do</span> <span class="s">{</span>
        <span class="k">warn</span> <span class="q">&quot;Unable to read preferences! $!\n&quot;</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span><span class="sc">;</span>

    <span class="k">while</span> <span class="s">(</span> <span class="q">&lt;$F&gt;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$k</span><span class="cm">,</span> <span class="i">$v</span> <span class="s">)</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/=/</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">chomp</span><span class="s">(</span> <span class="i">$v</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$pkg</span>{ <span class="i">$k</span> } = <span class="i">$v</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">close</span><span class="s">(</span> <span class="i">$F</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">%pkg</span> <span class="k">if</span> <span class="i">%pkg</span><span class="sc">;</span>
<span class="s">}</span>

<a name="legit_key-"></a><span class="k">sub </span><span class="m">legit_key</span> <span class="s">{</span>
    <span class="c"># Sanity check the prefs file&#39;s keys.</span>
    <span class="k">my</span> <span class="i">@keys</span> = <span class="q">qw(</span>
        <span class="q">SizeLimit HTTPProxy</span>
        <span class="q">LastInfection GUICheck DupeDB</span>
        <span class="q">TruncateLog SaveToLog</span>
        <span class="q">Whitelist Update ScanHidden</span>
        <span class="q">Thorough Recursive Mounted</span>
        <span class="q">Clickings</span>
    <span class="q">)</span><span class="sc">;</span>
    <span class="k">return</span> <span class="n">1</span> <span class="k">if</span> <span class="s">(</span> <span class="k">grep</span> <span class="s">{</span> <span class="i">$_</span>[ <span class="n">0</span> ] <span class="k">eq</span> <span class="i">$_</span> <span class="s">}</span> <span class="i">@keys</span> <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<a name="write_all-"></a><span class="k">sub </span><span class="m">write_all</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">%loc</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$paths</span> = <span class="w">ClamTk::App</span><span class="w">-&gt;get_path</span><span class="s">(</span> <span class="q">&#39;prefs&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">open</span><span class="s">(</span> <span class="k">my</span> <span class="i">$F</span><span class="cm">,</span> <span class="q">&#39;&gt;:encoding(UTF-8)&#39;</span><span class="cm">,</span> <span class="i">$paths</span> <span class="s">)</span>
        <span class="k">or</span> <span class="k">do</span> <span class="s">{</span>
        <span class="k">warn</span> <span class="q">&quot;Unable to write preferences! $!\n&quot;</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span><span class="sc">;</span>

    <span class="k">while</span> <span class="s">(</span> <span class="k">my</span> <span class="s">(</span> <span class="i">$k</span><span class="cm">,</span> <span class="i">$v</span> <span class="s">)</span> = <span class="k">each</span> <span class="i">%loc</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">legit_key</span><span class="s">(</span> <span class="i">$k</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">print</span> <span class="i">$F</span> <span class="q">&quot;$k=$v\n&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">close</span><span class="s">(</span> <span class="i">$F</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>

<a name="set_preference-"></a><span class="k">sub </span><span class="m">set_preference</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="k">undef</span><span class="cm">,</span> <span class="i">$wk</span><span class="cm">,</span> <span class="i">$wv</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>    <span class="c"># undef = package name</span>
    <span class="k">my</span> <span class="i">$paths</span> = <span class="w">ClamTk::App</span><span class="w">-&gt;get_path</span><span class="s">(</span> <span class="q">&#39;prefs&#39;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">open</span><span class="s">(</span> <span class="k">my</span> <span class="i">$F</span><span class="cm">,</span> <span class="q">&#39;&lt;:encoding(UTF-8)&#39;</span><span class="cm">,</span> <span class="i">$paths</span> <span class="s">)</span>
        <span class="k">or</span> <span class="k">do</span> <span class="s">{</span>
        <span class="k">warn</span> <span class="q">&quot;Unable to read preferences! $!\n&quot;</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">%pkg</span><span class="sc">;</span>
    <span class="k">while</span> <span class="s">(</span> <span class="q">&lt;$F&gt;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$k</span><span class="cm">,</span> <span class="i">$v</span> <span class="s">)</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/=/</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">chomp</span><span class="s">(</span> <span class="i">$v</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$pkg</span>{ <span class="i">$k</span> } = <span class="i">$v</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">close</span><span class="s">(</span> <span class="i">$F</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">open</span><span class="s">(</span> <span class="i">$F</span><span class="cm">,</span> <span class="q">&#39;&gt;:encoding(UTF-8)&#39;</span><span class="cm">,</span> <span class="i">$paths</span> <span class="s">)</span>
        <span class="k">or</span> <span class="k">return</span> <span class="n">-1</span><span class="sc">;</span>

    <span class="k">while</span> <span class="s">(</span> <span class="k">my</span> <span class="s">(</span> <span class="i">$k</span><span class="cm">,</span> <span class="i">$v</span> <span class="s">)</span> = <span class="k">each</span> <span class="i">%pkg</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">legit_key</span><span class="s">(</span> <span class="i">$k</span> <span class="s">)</span> &amp;&amp; <span class="s">(</span> <span class="i">$k</span> <span class="k">ne</span> <span class="i">$wk</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">print</span> <span class="i">$F</span> <span class="q">&quot;$k=$v\n&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">print</span> <span class="i">$F</span> <span class="q">&quot;$wk=$wv\n&quot;</span> <span class="k">if</span> <span class="s">(</span> <span class="i">legit_key</span><span class="s">(</span> <span class="i">$wk</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">close</span><span class="s">(</span> <span class="i">$F</span> <span class="s">)</span>
        <span class="k">or</span> <span class="k">warn</span> <span class="q">&quot;Couldn&#39;t close $paths: $!\n&quot;</span><span class="sc">;</span>
    <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>

<a name="get_preference-"></a><span class="k">sub </span><span class="m">get_preference</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="k">undef</span><span class="cm">,</span> <span class="i">$wanted</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>    <span class="c"># undef = package name</span>

    <span class="k">my</span> <span class="i">$paths</span> = <span class="w">ClamTk::App</span><span class="w">-&gt;get_path</span><span class="s">(</span> <span class="q">&#39;prefs&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%pkg</span><span class="sc">;</span>
    <span class="k">open</span><span class="s">(</span> <span class="k">my</span> <span class="i">$F</span><span class="cm">,</span> <span class="q">&#39;&lt;:encoding(UTF-8)&#39;</span><span class="cm">,</span> <span class="i">$paths</span> <span class="s">)</span>
        <span class="k">or</span> <span class="k">do</span> <span class="s">{</span>
        <span class="k">warn</span> <span class="q">&quot;Unable to read preferences! $!\n&quot;</span><span class="sc">;</span>
        <span class="k">return</span> <span class="n">0</span><span class="sc">;</span>
        <span class="s">}</span><span class="sc">;</span>

    <span class="k">while</span> <span class="s">(</span> <span class="q">&lt;$F&gt;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="s">(</span> <span class="i">$k</span><span class="cm">,</span> <span class="i">$v</span> <span class="s">)</span> = <span class="k">split</span><span class="s">(</span> <span class="q">/=/</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">chomp</span><span class="s">(</span> <span class="i">$v</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$pkg</span>{ <span class="i">$k</span> } = <span class="i">$v</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="k">close</span><span class="s">(</span> <span class="i">$F</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span> <span class="k">unless</span> <span class="i">%pkg</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$pkg</span>{ <span class="i">$wanted</span> } || <span class="q">&#39;&#39;</span><span class="sc">;</span>
<span class="s">}</span>

<a name="set_proxy-"></a><span class="k">sub </span><span class="m">set_proxy</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="k">undef</span><span class="cm">,</span> <span class="i">$ip</span><span class="cm">,</span> <span class="i">$port</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>    <span class="c"># undef = package name</span>

    <span class="c"># If the user doesn&#39;t set a port, we&#39;ll just jot down port 80.</span>
    <span class="i">$port</span> = <span class="i">$port</span> || <span class="q">&#39;80&#39;</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$path</span> = <span class="w">ClamTk::App</span><span class="w">-&gt;get_path</span><span class="s">(</span> <span class="q">&#39;db&#39;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># This gets clobbered every time.</span>
    <span class="c"># Doesn&#39;t need to be utf-8 friendly. I think.</span>
    <span class="k">open</span><span class="s">(</span> <span class="k">my</span> <span class="i">$FH</span><span class="cm">,</span> <span class="q">&#39;&gt;&#39;</span><span class="cm">,</span> <span class="q">&quot;$path/local.conf&quot;</span> <span class="s">)</span>
        <span class="k">or</span> <span class="k">return</span> <span class="n">-1</span><span class="sc">;</span>
    <span class="k">print</span> <span class="i">$FH</span> <span class="h">&lt;&lt;&quot;EOF&quot;</span><span class="sc">;</span>
<span class="hh">HTTPProxyServer $ip</span>
<span class="hh">HTTPProxyPort $port</span>
<span class="hh">DatabaseMirror db.local.clamav.net</span>
<span class="hh">DatabaseMirror database.clamav.net</span>
<span class="h">EOF</span>
    <span class="k">close</span><span class="s">(</span> <span class="i">$FH</span> <span class="s">)</span>
        <span class="k">or</span> <span class="k">warn</span> <span class="q">&quot;Couldn&#39;t close $path/local.conf: $!\n&quot;</span><span class="sc">;</span>
    <span class="k">return</span> <span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>

<span class="n">1</span><span class="sc">;</span>
<a name="EOF-"></a></pre>
</body>
</html>
