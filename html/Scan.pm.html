<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by perltidy on Sun Mar  9 08:19:24 2014 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Scan.pm</title>
<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #FFFFFF;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
</head>
<body>
<a name="-top-"></a>
<h1>Scan.pm</h1>
<hr />
<!-- contents of filename: Scan.pm -->
<pre>
<span class="c"># ClamTk, copyright (C) 2004-2014 Dave M</span>
<span class="c">#</span>
<span class="c"># This file is part of ClamTk (http://code.google.com/p/clamtk/).</span>
<span class="c">#</span>
<span class="c"># ClamTk is free software; you can redistribute it and/or modify it</span>
<span class="c"># under the terms of either:</span>
<span class="c">#</span>
<span class="c"># a) the GNU General Public License as published by the Free Software</span>
<span class="c"># Foundation; either version 1, or (at your option) any later version, or</span>
<span class="c">#</span>
<span class="c"># b) the &quot;Artistic License&quot;.</span>
<a name="package-ClamTk::Scan-"></a><span class="k">package </span><span class="i">ClamTk::Scan</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">Glib</span> <span class="q">&#39;TRUE&#39;</span><span class="cm">,</span> <span class="q">&#39;FALSE&#39;</span><span class="sc">;</span>

<span class="c"># use strict;</span>
<span class="c"># use warnings;</span>
<span class="i">$|</span> = <span class="n">1</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">constant</span> <span class="i">HATE_GNOME_SHELL</span>    <span class="cm">=&gt;</span> <span class="n">-6</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">constant</span> <span class="i">DESTROY_GNOME_SHELL</span> <span class="cm">=&gt;</span> <span class="n">-11</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">POSIX</span> <span class="q">&#39;locale_h&#39;</span><span class="cm">,</span>          <span class="q">&#39;strftime&#39;</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">File::Basename</span> <span class="q">&#39;basename&#39;</span><span class="cm">,</span> <span class="q">&#39;dirname&#39;</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Locale::gettext</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Encode</span> <span class="q">&#39;decode&#39;</span><span class="sc">;</span>

<span class="k">binmode</span><span class="s">(</span> <span class="w">STDIN</span><span class="cm">,</span>  <span class="q">&#39;:utf8&#39;</span> <span class="s">)</span><span class="sc">;</span>
<span class="k">binmode</span><span class="s">(</span> <span class="w">STDOUT</span><span class="cm">,</span> <span class="q">&#39;:utf8&#39;</span> <span class="s">)</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$SCAN</span><span class="sc">;</span>     <span class="c"># File handle for scanning</span>
<span class="k">my</span> <span class="i">$found</span><span class="sc">;</span>    <span class="c"># Holds information of bad stuff found</span>

<span class="k">my</span> <span class="i">$found_count</span> = <span class="n">0</span><span class="sc">;</span>    <span class="c"># Scalar number of bad stuff found</span>
<span class="k">my</span> <span class="i">$num_scanned</span> = <span class="n">0</span><span class="sc">;</span>    <span class="c"># Overall number of files scanned</span>
<span class="k">my</span> <span class="i">%dirs_scanned</span><span class="sc">;</span>       <span class="c"># Directories scanned</span>
<span class="k">my</span> <span class="i">$scan_pid</span><span class="sc">;</span>           <span class="c"># PID of scanner, for killing/cancelling scan</span>

<span class="k">my</span> <span class="i">$stopped</span> = <span class="n">1</span><span class="sc">;</span>            <span class="c"># Whether scanner is running or not</span>
<span class="k">my</span> <span class="i">$directive</span><span class="sc">;</span>              <span class="c"># Options sent to scanner</span>
<span class="k">my</span> <span class="i">$topbar</span><span class="sc">;</span>                 <span class="c"># Gtk2::InfoBar on top</span>
<span class="k">my</span> <span class="i">$bottombar</span><span class="sc">;</span>              <span class="c"># Gtk2::InfoBar on bottom</span>
<span class="k">my</span> <span class="i">$pb</span><span class="sc">;</span>                     <span class="c"># Gtk2::ProgressBar</span>
<span class="k">my</span> <span class="i">$spinner</span><span class="sc">;</span>                <span class="c"># Gtk2::Spinner</span>
<span class="k">my</span> <span class="i">$files_scanned_label</span><span class="sc">;</span>    <span class="c"># Gtk2::Label</span>
<span class="k">my</span> <span class="i">$threats_label</span><span class="sc">;</span>          <span class="c"># Gtk2::Label</span>
<span class="k">my</span> <span class="i">$dontshow</span><span class="sc">;</span>               <span class="c"># whether or not to show the preferences btn</span>

<span class="k">my</span> <span class="i">$window</span><span class="sc">;</span>

<a name="filter-"></a><span class="k">sub </span><span class="m">filter</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$pkg_name</span><span class="cm">,</span> <span class="i">$scanthis</span><span class="cm">,</span> <span class="i">$dontshow1</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="i">$dontshow</span> = <span class="i">$dontshow1</span><span class="sc">;</span>

    <span class="c"># We&#39;re gonna need these:</span>
    <span class="k">my</span> <span class="i">$paths</span> = <span class="w">ClamTk::App</span><span class="w">-&gt;get_path</span><span class="s">(</span> <span class="q">&#39;all&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">%prefs</span> = <span class="w">ClamTk::Prefs</span><span class="w">-&gt;get_all_prefs</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="c"># Don&#39;t bother doing anything if clamscan can&#39;t be found</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="k">-e</span> <span class="i">$paths</span>-&gt;{ <span class="w">clampath</span> } <span class="s">)</span> <span class="s">{</span>
        <span class="k">warn</span> <span class="q">&quot;Cannot scan without clamscan!\n&quot;</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># Begin popup &#39;scanning&#39; crap.</span>
    <span class="c"># We would normally use a statusicon, but GNOME</span>
    <span class="c"># does not support it??</span>
    <span class="i">$window</span> = <span class="w">Gtk2::Window</span><span class="w">-&gt;new</span><span class="sc">;</span>
    <span class="i">$window</span><span class="i">-&gt;set_deletable</span><span class="s">(</span> <span class="w">FALSE</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$window</span><span class="i">-&gt;signal_connect</span><span class="s">(</span>
        <span class="q">&#39;delete-event&#39;</span> <span class="cm">=&gt;</span> <span class="k">sub</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> !<span class="i">$stopped</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">return</span> <span class="w">TRUE</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="i">$window</span><span class="i">-&gt;set_title</span><span class="s">(</span> <span class="i">_</span><span class="s">(</span> <span class="q">&#39;Virus Scanner&#39;</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$window</span><span class="i">-&gt;set_border_width</span><span class="s">(</span> <span class="n">10</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$window</span><span class="i">-&gt;set_default_size</span><span class="s">(</span> <span class="n">300</span><span class="cm">,</span> <span class="n">80</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$images_dir</span> = <span class="w">ClamTk::App</span><span class="w">-&gt;get_path</span><span class="s">(</span> <span class="q">&#39;images&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">-e</span> <span class="q">&quot;$images_dir/clamtk.png&quot;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">my</span> <span class="i">$pixbuf</span>
            = <span class="w">Gtk2::Gdk::Pixbuf</span><span class="w">-&gt;new_from_file</span><span class="s">(</span> <span class="q">&quot;$images_dir/clamtk.png&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">my</span> <span class="i">$transparent</span> = <span class="i">$pixbuf</span><span class="i">-&gt;add_alpha</span><span class="s">(</span> <span class="w">TRUE</span><span class="cm">,</span> <span class="n">0xff</span><span class="cm">,</span> <span class="n">0xff</span><span class="cm">,</span> <span class="n">0xff</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$window</span><span class="i">-&gt;set_icon</span><span class="s">(</span> <span class="i">$transparent</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$eb</span> = <span class="w">Gtk2::EventBox</span><span class="w">-&gt;new</span><span class="sc">;</span>
    <span class="i">$window</span><span class="i">-&gt;add</span><span class="s">(</span> <span class="i">$eb</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$white</span> = <span class="w">Gtk2::Gdk::Color</span><span class="w">-&gt;new</span><span class="s">(</span> <span class="n">0xFFFF</span><span class="cm">,</span> <span class="n">0xFFFF</span><span class="cm">,</span> <span class="n">0xFFFF</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$eb</span><span class="i">-&gt;modify_bg</span><span class="s">(</span> <span class="q">&#39;normal&#39;</span><span class="cm">,</span> <span class="i">$white</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$box</span> = <span class="w">Gtk2::VBox</span><span class="w">-&gt;new</span><span class="s">(</span> <span class="w">FALSE</span><span class="cm">,</span> <span class="n">5</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$eb</span><span class="i">-&gt;add</span><span class="s">(</span> <span class="i">$box</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$hbox</span> = <span class="w">Gtk2::HBox</span><span class="w">-&gt;new</span><span class="s">(</span> <span class="w">FALSE</span><span class="cm">,</span> <span class="n">0</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$box</span><span class="i">-&gt;add</span><span class="s">(</span> <span class="i">$hbox</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$topbar</span> = <span class="w">Gtk2::InfoBar</span><span class="w">-&gt;new</span><span class="sc">;</span>
    <span class="i">$hbox</span><span class="i">-&gt;pack_start</span><span class="s">(</span> <span class="i">$topbar</span><span class="cm">,</span> <span class="w">TRUE</span><span class="cm">,</span> <span class="w">TRUE</span><span class="cm">,</span> <span class="n">5</span> <span class="s">)</span><span class="sc">;</span>

    <span class="w">Gtk2</span><span class="w">-&gt;main_iteration</span> <span class="k">while</span> <span class="s">(</span> <span class="w">Gtk2</span><span class="w">-&gt;events_pending</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$topbar</span><span class="i">-&gt;set_message_type</span><span class="s">(</span> <span class="q">&#39;other&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">set_infobar_text</span><span class="s">(</span> <span class="i">$topbar</span><span class="cm">,</span> <span class="i">_</span><span class="s">(</span> <span class="q">&#39;Preparing...&#39;</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="w">Gtk2</span><span class="w">-&gt;main_iteration</span> <span class="k">while</span> <span class="s">(</span> <span class="w">Gtk2</span><span class="w">-&gt;events_pending</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$spinner</span> = <span class="w">Gtk2::Spinner</span><span class="w">-&gt;new</span><span class="sc">;</span>
    <span class="i">$hbox</span><span class="i">-&gt;pack_start</span><span class="s">(</span> <span class="i">$spinner</span><span class="cm">,</span> <span class="w">FALSE</span><span class="cm">,</span> <span class="w">FALSE</span><span class="cm">,</span> <span class="n">5</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$pb</span> = <span class="w">Gtk2::ProgressBar</span><span class="w">-&gt;new</span><span class="sc">;</span>
    <span class="i">$box</span><span class="i">-&gt;pack_start</span><span class="s">(</span> <span class="i">$pb</span><span class="cm">,</span> <span class="w">FALSE</span><span class="cm">,</span> <span class="w">FALSE</span><span class="cm">,</span> <span class="n">5</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$pb</span><span class="i">-&gt;set_fraction</span><span class="s">(</span> <span class="n">.25</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$files_scanned_label</span>
        = <span class="w">Gtk2::Label</span><span class="w">-&gt;new</span><span class="s">(</span> <span class="k">sprintf</span> <span class="i">_</span><span class="s">(</span> <span class="q">&quot;Files scanned: %d&quot;</span> <span class="s">)</span><span class="cm">,</span> <span class="i">$num_scanned</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$files_scanned_label</span><span class="i">-&gt;set_alignment</span><span class="s">(</span> <span class="n">0.0</span><span class="cm">,</span> <span class="n">0.5</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$threats_label</span>
        = <span class="w">Gtk2::Label</span><span class="w">-&gt;new</span><span class="s">(</span> <span class="k">sprintf</span> <span class="i">_</span><span class="s">(</span> <span class="q">&quot;Possible threats: %d&quot;</span> <span class="s">)</span><span class="cm">,</span>
        <span class="i">$found_count</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$threats_label</span><span class="i">-&gt;set_alignment</span><span class="s">(</span> <span class="n">0.0</span><span class="cm">,</span> <span class="n">0.5</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$text_box</span> = <span class="w">Gtk2::VBox</span><span class="w">-&gt;new</span><span class="s">(</span> <span class="w">FALSE</span><span class="cm">,</span> <span class="n">5</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$text_box</span><span class="i">-&gt;add</span><span class="s">(</span> <span class="i">$files_scanned_label</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$text_box</span><span class="i">-&gt;add</span><span class="s">(</span> <span class="i">$threats_label</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$bottombar</span> = <span class="w">Gtk2::InfoBar</span><span class="w">-&gt;new</span><span class="sc">;</span>
    <span class="i">$box</span><span class="i">-&gt;pack_start</span><span class="s">(</span> <span class="i">$bottombar</span><span class="cm">,</span> <span class="w">FALSE</span><span class="cm">,</span> <span class="w">FALSE</span><span class="cm">,</span> <span class="n">5</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$bottombar</span><span class="i">-&gt;can_focus</span><span class="s">(</span> <span class="w">FALSE</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$bottombar</span><span class="i">-&gt;set_message_type</span><span class="s">(</span> <span class="q">&#39;info&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$bottombar</span><span class="i">-&gt;add_button</span><span class="s">(</span> <span class="q">&#39;gtk-cancel&#39;</span><span class="cm">,</span> <span class="i">HATE_GNOME_SHELL</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="i">$dontshow</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$bottombar</span><span class="i">-&gt;add_button</span><span class="s">(</span> <span class="q">&#39;gtk-preferences&#39;</span><span class="cm">,</span> <span class="i">DESTROY_GNOME_SHELL</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="i">$bottombar</span><span class="i">-&gt;signal_connect</span><span class="s">(</span>
        <span class="w">response</span> <span class="cm">=&gt;</span> <span class="k">sub</span> <span class="s">{</span>
            <span class="k">my</span> <span class="s">(</span> <span class="i">$bar</span><span class="cm">,</span> <span class="i">$button</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$button</span> <span class="k">eq</span> <span class="q">&#39;cancel&#39;</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">cancel_scan</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$button</span> <span class="k">eq</span> <span class="q">&#39;help&#39;</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">system</span><span class="s">(</span> <span class="q">&#39;clamtk &amp;&#39;</span> <span class="s">)</span><span class="sc">;</span>
                <span class="k">return</span> <span class="w">FALSE</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="i">$bottombar</span><span class="i">-&gt;get_content_area</span><span class="i">-&gt;add</span><span class="s">(</span> <span class="i">$text_box</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$window</span><span class="i">-&gt;show_all</span><span class="sc">;</span>
    <span class="i">$window</span><span class="i">-&gt;set_gravity</span><span class="s">(</span> <span class="q">&#39;south-east&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$window</span><span class="i">-&gt;queue_draw</span><span class="sc">;</span>
    <span class="w">Gtk2</span><span class="w">-&gt;main_iteration</span> <span class="k">while</span> <span class="s">(</span> <span class="w">Gtk2</span><span class="w">-&gt;events_pending</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># By default, we ignore .gvfs directories.</span>
    <span class="c"># Once we figure out KDE&#39;s process, we&#39;ll exclude that too.</span>
    <span class="c">#&lt;&lt;&lt;</span>
    <span class="k">for</span> <span class="k">my</span> <span class="i">$m</span> <span class="s">(</span>
            <span class="q">&#39;smb4k&#39;</span><span class="cm">,</span>
            <span class="q">&quot;/run/user/$ENV{USER}/gvfs&quot;</span><span class="cm">,</span>
            <span class="q">&quot;$ENV{HOME}/.gvfs&quot;</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$directive</span> .= <span class="q">&quot; --exclude-dir=$m&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="c">#&gt;&gt;&gt;</span>

    <span class="c"># Now strip whitelisted directories</span>
    <span class="k">for</span> <span class="k">my</span> <span class="i">$ignore</span> <span class="s">(</span>
        <span class="k">split</span><span class="s">(</span>
            <span class="q">/;/</span><span class="cm">,</span>
            <span class="w">ClamTk::Prefs</span><span class="w">-&gt;get_preference</span><span class="s">(</span> <span class="q">&#39;Whitelist&#39;</span> <span class="s">)</span>
                . <span class="i">$paths</span>-&gt;{ <span class="w">whitelist_dir</span> }
        <span class="s">)</span>
        <span class="s">)</span>
    <span class="s">{</span>
        <span class="i">$directive</span> .= <span class="q">&quot; --exclude-dir=&quot;</span> . <span class="k">quotemeta</span><span class="s">(</span> <span class="i">$ignore</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># Remove mail directories for now -</span>
    <span class="c"># until we can parse them... sigh.</span>
    <span class="c"># Not all of these can be appended to $HOME for a more</span>
    <span class="c"># specific path - kmail (e.g.) is somewhere</span>
    <span class="c"># under $HOME/.kde/blah/foo/...</span>
    <span class="k">my</span> <span class="i">@maildirs</span> = <span class="q">qw(</span>
        <span class="q">.thunderbird	.mozilla-thunderbird</span>
        <span class="q">Mail	kmail   evolution</span>
    <span class="q">)</span><span class="sc">;</span>
    <span class="k">for</span> <span class="k">my</span> <span class="i">$mailbox</span> <span class="s">(</span> <span class="i">@maildirs</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$directive</span> .= <span class="q">&quot; --exclude-dir=$mailbox&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># remove the hidden files if chosen:</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="i">$prefs</span>{ <span class="w">ScanHidden</span> } <span class="s">)</span> <span class="s">{</span>
        <span class="i">$directive</span> .= <span class="q">&#39; --exclude=&quot;\/\.&quot;&#39;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># symlinks:</span>
    <span class="c"># The symlink stuff from clamscan requires &gt;= 0.97.</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$version</span> <span class="s">)</span> = <span class="w">ClamTk::App</span><span class="w">-&gt;get_AV_version</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="c"># Ensure it&#39;s just digits and dots:</span>
    <span class="i">$version</span> =~ <span class="q">s/[^0-9\.]//g</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span>   <span class="s">(</span> <span class="i">$version</span> <span class="k">cmp</span> <span class="q">&#39;0.97&#39;</span> <span class="s">)</span> == <span class="n">0</span>
        || <span class="s">(</span> <span class="i">$version</span> <span class="k">cmp</span> <span class="q">&#39;0.97&#39;</span> <span class="s">)</span> == <span class="n">1</span> <span class="s">)</span>
    <span class="s">{</span>
        <span class="i">$directive</span> .= <span class="q">&#39; --follow-dir-symlinks=1&#39;</span><span class="sc">;</span>
        <span class="i">$directive</span> .= <span class="q">&#39; --follow-file-symlinks=1&#39;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># we&#39;ll count this as ! $stopped</span>
    <span class="c">#$stopped = 0;</span>

    <span class="c"># reset %$found</span>
    <span class="i">$found</span> = <span class="s">{</span><span class="s">}</span><span class="sc">;</span>

    <span class="c"># These lines are for &#39;thorough&#39;. :)</span>
    <span class="c"># If it&#39;s selected, we add detection for both</span>
    <span class="c"># potentially unwanted applications and broken executables.</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$prefs</span>{ <span class="w">Thorough</span> } <span class="s">)</span> <span class="s">{</span>
        <span class="i">$directive</span> .= <span class="q">&#39; --detect-pua --detect-broken&#39;</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$directive</span> =~ <span class="q">s/\s--detect-pua --detect-broken//</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># only a single file</span>

    <span class="c"># By default, 20Mb is the largest we go -</span>
    <span class="c"># unless the preference is to ignore size.</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="i">$prefs</span>{ <span class="w">SizeLimit</span> } <span class="s">)</span> <span class="s">{</span>
        <span class="i">$directive</span> .= <span class="q">&#39; --max-filesize=20M&#39;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="i">$prefs</span>{ <span class="w">Recursive</span> } <span class="s">)</span> <span class="s">{</span>
        <span class="i">$directive</span> .= <span class="q">&#39; --max-dir-recursion=1&#39;</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$directive</span> .= <span class="q">&#39; --recursive=yes&#39;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="i">scan</span><span class="s">(</span> <span class="i">$scanthis</span><span class="cm">,</span> <span class="i">$directive</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">clean_up</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<a name="scan-"></a><span class="k">sub </span><span class="m">scan</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$path_to_scan</span><span class="cm">,</span> <span class="i">$directive</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
    <span class="i">$pb</span><span class="i">-&gt;set_fraction</span><span class="s">(</span> <span class="n">.50</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$spinner</span><span class="i">-&gt;start</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$quoted</span> = <span class="k">quotemeta</span><span class="s">(</span> <span class="i">$path_to_scan</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># Leave if we have no real path</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="i">$path_to_scan</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">warn</span> <span class="q">&quot;No path to scan!\n&quot;</span><span class="sc">;</span>
        <span class="k">return</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$paths</span>   = <span class="w">ClamTk::App</span><span class="w">-&gt;get_path</span><span class="s">(</span> <span class="q">&#39;all&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$command</span> = <span class="i">$paths</span>-&gt;{ <span class="w">clamscan</span> }<span class="sc">;</span>

    <span class="c"># Use the user&#39;s sig db if it&#39;s selected</span>
    <span class="k">if</span> <span class="s">(</span> <span class="w">ClamTk::Prefs</span><span class="w">-&gt;get_preference</span><span class="s">(</span> <span class="q">&#39;Update&#39;</span> <span class="s">)</span> <span class="k">eq</span> <span class="q">&#39;single&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$command</span> .= <span class="q">&quot; --database=$paths-&gt;{db}&quot;</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># Implicit fork; gives us the PID of clamscan so we can</span>
    <span class="c"># kill it if the user hits the Stop button</span>
    <span class="c">#&lt;&lt;&lt;</span>
    <span class="w">Gtk2</span><span class="w">-&gt;main_iteration</span> <span class="k">while</span> <span class="s">(</span> <span class="w">Gtk2</span><span class="w">-&gt;events_pending</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$scan_pid</span>
        = <span class="k">open</span><span class="s">(</span> <span class="i">$SCAN</span><span class="cm">,</span> <span class="q">&#39;-|&#39;</span><span class="cm">,</span> <span class="q">&quot;$command $directive $quoted 2&gt;&amp;1&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">defined</span><span class="s">(</span> <span class="i">$scan_pid</span> <span class="s">)</span> <span class="k">or</span> <span class="k">die</span> <span class="q">&quot;couldn&#39;t fork: $!\n&quot;</span><span class="sc">;</span>
    <span class="i">$window</span><span class="i">-&gt;queue_draw</span><span class="sc">;</span>
    <span class="w">Gtk2</span><span class="w">-&gt;main_iteration</span> <span class="k">while</span> <span class="s">(</span> <span class="w">Gtk2</span><span class="w">-&gt;events_pending</span> <span class="s">)</span><span class="sc">;</span>
    <span class="c">#&gt;&gt;&gt;</span>
    <span class="c"># binmode( $SCAN, &#39;:utf8:bytes&#39; );</span>

    <span class="w">Gtk2</span><span class="w">-&gt;main_iteration</span> <span class="k">while</span> <span class="s">(</span> <span class="w">Gtk2</span><span class="w">-&gt;events_pending</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">while</span> <span class="s">(</span> <span class="q">&lt;$SCAN&gt;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="w">Gtk2</span><span class="w">-&gt;main_iteration</span> <span class="k">while</span> <span class="s">(</span> <span class="w">Gtk2</span><span class="w">-&gt;events_pending</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$window</span><span class="i">-&gt;queue_draw</span><span class="sc">;</span>

        <span class="k">next</span> <span class="k">if</span> <span class="s">(</span> <span class="q">/^LibClamAV/</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">next</span> <span class="k">if</span> <span class="s">(</span> <span class="q">/^\s*$/</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="s">(</span> <span class="i">$file</span><span class="cm">,</span> <span class="i">$status</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">if</span> <span class="s">(</span> <span class="q">/(.*?): ([^:]+) FOUND/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$file</span>   = <span class="i">$1</span><span class="sc">;</span>
            <span class="i">$status</span> = <span class="i">$2</span><span class="sc">;</span>
        <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="q">/(.*?): (OK)$/</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$file</span>   = <span class="i">$1</span><span class="sc">;</span>
            <span class="i">$status</span> = <span class="i">$2</span><span class="sc">;</span>
        <span class="s">}</span>    <span class="c">#else {</span>
             <span class="c">#warn &quot;something else: file = &lt;$file&gt;, stat = &lt;$status&gt;\n&quot;;</span>
             <span class="c">#}</span>

        <span class="c"># Ensure the file is still there (things get moved)</span>
        <span class="c"># and that it got scanned</span>
        <span class="k">next</span> <span class="k">unless</span> <span class="s">(</span> <span class="i">$file</span> &amp;&amp; <span class="k">-e</span> <span class="i">$file</span> &amp;&amp; <span class="i">$status</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">next</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$status</span> =~ <span class="q">/module failure/</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">chomp</span><span class="s">(</span> <span class="i">$file</span> <span class="s">)</span>   <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$file</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">chomp</span><span class="s">(</span> <span class="i">$status</span> <span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="k">defined</span> <span class="i">$status</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">my</span> <span class="i">$dirname</span> = <span class="i">decode</span><span class="s">(</span> <span class="q">&#39;UTF-8&#39;</span><span class="cm">,</span> <span class="i">dirname</span><span class="s">(</span> <span class="i">$file</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
        <span class="c">#&lt;&lt;&lt;</span>
        <span class="c"># Display stuff in popup infobar</span>
        <span class="i">set_infobar_text</span><span class="s">(</span> <span class="i">$topbar</span><span class="cm">,</span>
            <span class="k">sprintf</span><span class="s">(</span> <span class="i">_</span><span class="s">(</span> <span class="q">&#39;Scanning %s...&#39;</span> <span class="s">)</span><span class="cm">,</span> <span class="i">$dirname</span> <span class="s">)</span>
        <span class="s">)</span><span class="sc">;</span>
        <span class="c">#&gt;&gt;&gt;</span>
        <span class="i">$topbar</span><span class="i">-&gt;show_all</span><span class="sc">;</span>
        <span class="w">Gtk2</span><span class="w">-&gt;main_iteration</span> <span class="k">while</span> <span class="s">(</span> <span class="w">Gtk2</span><span class="w">-&gt;events_pending</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$window</span><span class="i">-&gt;queue_draw</span><span class="sc">;</span>

        <span class="c"># Lots of temporary things under /tmp/clamav;</span>
        <span class="c"># we&#39;ll just ignore them.</span>
        <span class="i">$dirs_scanned</span>{ <span class="i">$dirname</span> } = <span class="n">1</span>
            <span class="k">unless</span> <span class="s">(</span> <span class="i">dirname</span><span class="s">(</span> <span class="i">$file</span> <span class="s">)</span> =~ <span class="q">/\/tmp\/clamav/</span>
            || <span class="i">dirname</span><span class="s">(</span> <span class="i">$file</span> <span class="s">)</span> <span class="k">eq</span> <span class="q">&#39;.&#39;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># Do not show files in archives - we just want the end-result.</span>
        <span class="c"># It still scans and we still show the result.</span>
        <span class="k">next</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$file</span> =~ <span class="q">/\/tmp\/clamav/</span> <span class="s">)</span><span class="sc">;</span>

        <span class="c"># $status is the &quot;virus&quot; name.</span>
        <span class="i">$status</span> =~ <span class="q">s/\s+FOUND$//</span><span class="sc">;</span>

        <span class="c"># These aren&#39;t necessarily clean (despite the variable&#39;s name)</span>
        <span class="c"># - we just don&#39;t want them counted as viruses</span>
        <span class="k">my</span> <span class="i">$clean_words</span> = <span class="k">join</span><span class="s">(</span> <span class="q">&#39;|&#39;</span><span class="cm">,</span>
            <span class="q">&#39;OK&#39;</span><span class="cm">,</span>
            <span class="q">&#39;Zip module failure&#39;</span><span class="cm">,</span>
            <span class="q">&quot;RAR module failure&quot;</span><span class="cm">,</span>
            <span class="q">&#39;Encrypted.RAR&#39;</span><span class="cm">,</span>
            <span class="q">&#39;Encrypted.Zip&#39;</span><span class="cm">,</span>
            <span class="q">&#39;Empty file&#39;</span><span class="cm">,</span>
            <span class="q">&#39;Excluded&#39;</span><span class="cm">,</span>
            <span class="q">&#39;Input/Output error&#39;</span><span class="cm">,</span>
            <span class="q">&#39;Files number limit exceeded&#39;</span><span class="cm">,</span>
            <span class="q">&#39;handler error&#39;</span><span class="cm">,</span>
            <span class="q">&#39;Broken.Executable&#39;</span><span class="cm">,</span>
            <span class="q">&#39;Oversized.Zip&#39;</span><span class="cm">,</span>
            <span class="q">&#39;Symbolic link&#39;</span> <span class="s">)</span><span class="sc">;</span>

        <span class="k">if</span> <span class="s">(</span> <span class="i">$status</span> !~ <span class="q">/$clean_words/</span> <span class="s">)</span> <span class="s">{</span>    <span class="c"># a virus</span>
            <span class="i">$found</span>-&gt;{ <span class="i">$found_count</span> }-&gt;{ <span class="w">name</span> }   = <span class="i">$file</span><span class="sc">;</span>
            <span class="i">$found</span>-&gt;{ <span class="i">$found_count</span> }-&gt;{ <span class="w">status</span> } = <span class="i">$status</span><span class="sc">;</span>
            <span class="i">$found</span>-&gt;{ <span class="i">$found_count</span> }-&gt;{ <span class="w">action</span> } = <span class="i">_</span><span class="s">(</span> <span class="q">&#39;None&#39;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="i">$found_count</span>++<span class="sc">;</span>
            <span class="i">$threats_label</span><span class="i">-&gt;set_text</span><span class="s">(</span> <span class="k">sprintf</span> <span class="i">_</span><span class="s">(</span> <span class="q">&quot;Possible threats: %d&quot;</span> <span class="s">)</span><span class="cm">,</span>
                <span class="i">$found_count</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>

        <span class="i">$num_scanned</span>++<span class="sc">;</span>
        <span class="i">$files_scanned_label</span><span class="i">-&gt;set_text</span><span class="s">(</span> <span class="k">sprintf</span> <span class="i">_</span><span class="s">(</span> <span class="q">&quot;Files scanned: %d&quot;</span> <span class="s">)</span><span class="cm">,</span>
            <span class="i">$num_scanned</span> <span class="s">)</span><span class="sc">;</span>

        <span class="w">Gtk2</span><span class="w">-&gt;main_iteration</span> <span class="k">while</span> <span class="s">(</span> <span class="w">Gtk2</span><span class="w">-&gt;events_pending</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="w">Gtk2</span><span class="w">-&gt;main_iteration</span> <span class="k">while</span> <span class="s">(</span> <span class="w">Gtk2</span><span class="w">-&gt;events_pending</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># Done scanning - close filehandle and return to</span>
    <span class="c"># filter() and then to clean-up</span>
    <span class="k">close</span><span class="s">(</span> <span class="i">$SCAN</span> <span class="s">)</span><span class="sc">;</span>    <span class="c"># or warn &quot;Unable to close scanner! $!\n&quot;;</span>
<span class="s">}</span>

<a name="cancel_scan-"></a><span class="k">sub </span><span class="m">cancel_scan</span> <span class="s">{</span>
    <span class="k">kill</span> <span class="n">15</span><span class="cm">,</span> <span class="i">$scan_pid</span> + <span class="n">1</span><span class="sc">;</span>
    <span class="k">waitpid</span><span class="s">(</span> <span class="i">$scan_pid</span> + <span class="n">1</span><span class="cm">,</span> <span class="n">0</span> <span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$scan_pid</span> + <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">kill</span> <span class="n">15</span><span class="cm">,</span> <span class="i">$scan_pid</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$scan_pid</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">waitpid</span><span class="s">(</span> <span class="i">$scan_pid</span><span class="cm">,</span> <span class="n">0</span> <span class="s">)</span> <span class="k">if</span> <span class="s">(</span> <span class="i">$scan_pid</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">close</span><span class="s">(</span> <span class="i">$SCAN</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$stopped</span> = <span class="n">1</span><span class="sc">;</span>
<span class="s">}</span>

<a name="clean_up-"></a><span class="k">sub </span><span class="m">clean_up</span> <span class="s">{</span>
    <span class="i">set_infobar_text</span><span class="s">(</span> <span class="i">$topbar</span><span class="cm">,</span> <span class="i">_</span><span class="s">(</span> <span class="q">&#39;Cleaning up...&#39;</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$pb</span><span class="i">-&gt;set_fraction</span><span class="s">(</span> <span class="n">.75</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$spinner</span><span class="i">-&gt;stop</span><span class="sc">;</span>
    <span class="i">$spinner</span><span class="i">-&gt;hide</span><span class="sc">;</span>
    <span class="i">destroy_buttons</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">add_closing_buttons</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$message</span> = <span class="q">&#39;&#39;</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="i">$found_count</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$message</span> = <span class="i">_</span><span class="s">(</span> <span class="q">&#39;Scanning complete&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$message</span> = <span class="i">_</span><span class="s">(</span> <span class="q">&#39;Possible threats found&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="i">set_infobar_text</span><span class="s">(</span> <span class="i">$topbar</span><span class="cm">,</span> <span class="i">_</span><span class="s">(</span> <span class="i">$message</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># Save scan information</span>
    <span class="i">logit</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>

    <span class="i">$pb</span><span class="i">-&gt;set_fraction</span><span class="s">(</span> <span class="n">1.00</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="i">$found_count</span> <span class="s">)</span> <span class="s">{</span>
        <span class="w">ClamTk::Results</span><span class="w">-&gt;show_window</span><span class="s">(</span> <span class="i">$found</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">bad_popup</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="c"># reset things</span>
    <span class="i">$num_scanned</span>  = <span class="n">0</span><span class="sc">;</span>
    <span class="i">$found_count</span>  = <span class="n">0</span><span class="sc">;</span>
    <span class="i">%dirs_scanned</span> = <span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="i">$stopped</span>      = <span class="n">1</span><span class="sc">;</span>
    <span class="i">$directive</span>    = <span class="q">&#39;&#39;</span><span class="sc">;</span>
<span class="s">}</span>

<a name="bad_popup-"></a><span class="k">sub </span><span class="m">bad_popup</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$dialog</span> = <span class="w">Gtk2::MessageDialog</span><span class="w">-&gt;new</span><span class="s">(</span>
        <span class="i">$window</span><span class="cm">,</span> <span class="s">[</span> <span class="q">qw| modal destroy-with-parent |</span> <span class="s">]</span><span class="cm">,</span>
        <span class="q">&#39;info&#39;</span><span class="cm">,</span> <span class="q">&#39;close&#39;</span><span class="cm">,</span> <span class="i">_</span><span class="s">(</span> <span class="q">&#39;No threats found&#39;</span> <span class="s">)</span><span class="cm">,</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="i">$dialog</span><span class="i">-&gt;run</span><span class="sc">;</span>
    <span class="i">$dialog</span><span class="i">-&gt;destroy</span><span class="sc">;</span>
<span class="s">}</span>

<a name="logit-"></a><span class="k">sub </span><span class="m">logit</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$db_total</span> = <span class="w">ClamTk::App</span><span class="w">-&gt;get_sigtool_info</span><span class="s">(</span> <span class="q">&#39;count&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$REPORT</span><span class="sc">;</span>    <span class="c"># filehandle for histories log</span>

    <span class="c">#&lt;&lt;&lt;</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$mon</span><span class="cm">,</span> <span class="i">$day</span><span class="cm">,</span> <span class="i">$year</span> <span class="s">)</span>
        = <span class="k">split</span> <span class="q">/ /</span><span class="cm">,</span> <span class="i">strftime</span><span class="s">(</span> <span class="q">&#39;%b %d %Y&#39;</span><span class="cm">,</span> <span class="k">localtime</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># Save date of scan</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$found_count</span> &gt; <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
        <span class="w">ClamTk::Prefs</span><span class="w">-&gt;set_preference</span><span class="s">(</span>
                <span class="q">&#39;LastInfection&#39;</span><span class="cm">,</span> <span class="q">&quot;$day $mon $year&quot;</span>
        <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="c">#&gt;&gt;&gt;</span>

    <span class="k">my</span> <span class="i">%prefs</span> = <span class="w">ClamTk::Prefs</span><span class="w">-&gt;get_all_prefs</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$paths</span> = <span class="w">ClamTk::App</span><span class="w">-&gt;get_path</span><span class="s">(</span> <span class="q">&#39;history&#39;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$virus_log</span>
        = <span class="i">$paths</span> . <span class="q">&quot;/&quot;</span> . <span class="i">decode</span><span class="s">(</span> <span class="q">&#39;utf8&#39;</span><span class="cm">,</span> <span class="q">&quot;$mon-$day-$year&quot;</span> <span class="s">)</span> . <span class="q">&#39;.log&#39;</span><span class="sc">;</span>

    <span class="c">#&lt;&lt;&lt;</span>
    <span class="c"># sort the directories scanned for display</span>
    <span class="k">my</span> <span class="i">@sorted</span> = <span class="k">sort</span> <span class="s">{</span> <span class="i">$a</span> <span class="k">cmp</span> <span class="i">$b</span> <span class="s">}</span> <span class="k">keys</span> <span class="i">%dirs_scanned</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="k">open</span> <span class="i">$REPORT</span><span class="cm">,</span> <span class="q">&#39;&gt;&gt;:encoding(UTF-8)&#39;</span><span class="cm">,</span> <span class="i">$virus_log</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="i">$REPORT</span> <span class="q">&quot;\nClamTk, v&quot;</span><span class="cm">,</span>
            <span class="w">ClamTk::App</span><span class="w">-&gt;get_TK_version</span><span class="s">(</span><span class="s">)</span><span class="cm">,</span> <span class="q">&quot;\n&quot;</span><span class="cm">,</span>
            <span class="k">scalar</span> <span class="k">localtime</span><span class="cm">,</span>
            <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">$REPORT</span> <span class="k">sprintf</span> <span class="i">_</span><span class="s">(</span>
                <span class="q">&quot;ClamAV Signatures: %d\n&quot;</span> <span class="s">)</span><span class="cm">,</span>
                <span class="i">$db_total</span><span class="sc">;</span>
        <span class="k">print</span> <span class="i">$REPORT</span> <span class="i">_</span><span class="s">(</span> <span class="q">&quot;Directories Scanned:\n&quot;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="k">for</span> <span class="k">my</span> <span class="i">$list</span> <span class="s">(</span> <span class="i">@sorted</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">print</span> <span class="i">$REPORT</span> <span class="q">&quot;$list\n&quot;</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="k">printf</span> <span class="i">$REPORT</span> <span class="i">_</span><span class="s">(</span>
            <span class="q">&quot;\nFound %d possible %s (%d %s scanned).\n\n&quot;</span> <span class="s">)</span><span class="cm">,</span>
            <span class="i">$found_count</span><span class="cm">,</span>
            <span class="i">$found_count</span> == <span class="n">1</span> ? <span class="i">_</span><span class="s">(</span> <span class="q">&#39;threat&#39;</span> <span class="s">)</span> <span class="co">:</span> <span class="i">_</span><span class="s">(</span> <span class="q">&#39;threats&#39;</span> <span class="s">)</span><span class="cm">,</span>
            <span class="i">$num_scanned</span><span class="cm">,</span>
            <span class="i">$num_scanned</span> == <span class="n">1</span> ? <span class="i">_</span><span class="s">(</span> <span class="q">&#39;file&#39;</span> <span class="s">)</span> <span class="co">:</span> <span class="i">_</span><span class="s">(</span> <span class="q">&#39;files&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
            <span class="k">warn</span> <span class="q">&quot;Could not write to logfile. Check permissions.\n&quot;</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="c">#&gt;&gt;&gt;</span>

    <span class="c"># Set the minimum sizes for the two columns,</span>
    <span class="c"># the filename and its status - if we&#39;re saving a log.</span>
    <span class="k">my</span> <span class="i">$lsize</span> = <span class="n">20</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$rsize</span> = <span class="n">20</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$found_count</span> == <span class="n">0</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">print</span> <span class="i">$REPORT</span> <span class="i">_</span><span class="s">(</span> <span class="q">&quot;No threats found.\n&quot;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="c"># Now get the longest lengths of the column contents.</span>
        <span class="k">for</span> <span class="k">my</span> <span class="i">$length</span> <span class="s">(</span> <span class="k">sort</span> <span class="k">keys</span> <span class="i">%$found</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$lsize</span>
                = <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$found</span>-&gt;{ <span class="i">$length</span> }-&gt;{ <span class="w">name</span> } <span class="s">)</span> &gt; <span class="i">$lsize</span> <span class="s">)</span>
                ? <span class="k">length</span><span class="s">(</span> <span class="i">$found</span>-&gt;{ <span class="i">$length</span> }-&gt;{ <span class="w">name</span> } <span class="s">)</span>
                <span class="co">:</span> <span class="i">$lsize</span><span class="sc">;</span>
            <span class="i">$rsize</span>
                = <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$found</span>-&gt;{ <span class="i">$length</span> }-&gt;{ <span class="w">status</span> } <span class="s">)</span> &gt; <span class="i">$rsize</span> <span class="s">)</span>
                ? <span class="k">length</span><span class="s">(</span> <span class="i">$found</span>-&gt;{ <span class="i">$length</span> }-&gt;{ <span class="w">status</span> } <span class="s">)</span>
                <span class="co">:</span> <span class="i">$rsize</span><span class="sc">;</span>
        <span class="s">}</span>
        <span class="c"># Set a buffer which is probably unnecessary.</span>
        <span class="i">$lsize</span> += <span class="n">5</span><span class="sc">;</span>
        <span class="i">$rsize</span> += <span class="n">5</span><span class="sc">;</span>
        <span class="c"># Print to the log:</span>
        <span class="k">for</span> <span class="k">my</span> <span class="i">$num</span> <span class="s">(</span> <span class="k">sort</span> <span class="k">keys</span> <span class="i">%$found</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">printf</span> <span class="i">$REPORT</span> <span class="q">&quot;%-${lsize}s %-${rsize}s\n&quot;</span><span class="cm">,</span>
                <span class="i">decode</span><span class="s">(</span> <span class="q">&#39;utf8&#39;</span><span class="cm">,</span> <span class="i">$found</span>-&gt;{ <span class="i">$num</span> }-&gt;{ <span class="w">name</span> } <span class="s">)</span><span class="cm">,</span>
                <span class="i">$found</span>-&gt;{ <span class="i">$num</span> }-&gt;{ <span class="w">status</span> }<span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="k">print</span> <span class="i">$REPORT</span> <span class="q">&#39;-&#39;</span> x <span class="s">(</span> <span class="i">$lsize</span> + <span class="i">$rsize</span> + <span class="n">5</span> <span class="s">)</span><span class="cm">,</span> <span class="q">&quot;\n&quot;</span><span class="sc">;</span>
    <span class="k">close</span><span class="s">(</span> <span class="i">$REPORT</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<a name="set_infobar_text-"></a><span class="k">sub </span><span class="m">set_infobar_text</span> <span class="s">{</span>
    <span class="k">my</span> <span class="s">(</span> <span class="i">$bar</span><span class="cm">,</span> <span class="i">$text</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

    <span class="w">Gtk2</span><span class="w">-&gt;main_iteration</span> <span class="k">while</span> <span class="s">(</span> <span class="w">Gtk2</span><span class="w">-&gt;events_pending</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">for</span> <span class="k">my</span> <span class="i">$c</span> <span class="s">(</span> <span class="i">$bar</span><span class="i">-&gt;get_content_area</span><span class="i">-&gt;get_children</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$c</span><span class="i">-&gt;isa</span><span class="s">(</span> <span class="q">&#39;Gtk2::Label&#39;</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$c</span><span class="i">-&gt;set_text</span><span class="s">(</span> <span class="i">$text</span> <span class="s">)</span><span class="sc">;</span>
            <span class="w">Gtk2</span><span class="w">-&gt;main_iteration</span> <span class="k">while</span> <span class="s">(</span> <span class="w">Gtk2</span><span class="w">-&gt;events_pending</span> <span class="s">)</span><span class="sc">;</span>
            <span class="k">return</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="c">#&lt;&lt;&lt;</span>
    <span class="k">my</span> <span class="i">$label</span> = <span class="w">Gtk2::Label</span><span class="w">-&gt;new</span><span class="sc">;</span>
    <span class="i">$label</span><span class="i">-&gt;set_text</span><span class="s">(</span> <span class="i">_</span><span class="s">(</span> <span class="i">$text</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$label</span><span class="i">-&gt;set_alignment</span><span class="s">(</span> <span class="n">0.0</span><span class="cm">,</span> <span class="n">0.5</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$label</span><span class="i">-&gt;set_ellipsize</span><span class="s">(</span> <span class="q">&#39;middle&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$bar</span><span class="i">-&gt;get_content_area</span><span class="i">-&gt;add</span><span class="s">(</span>
            <span class="c">#Gtk2::Label-&gt;new( _( $text ) )</span>
            <span class="i">$label</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="c">#&gt;&gt;&gt;</span>
    <span class="i">$window</span><span class="i">-&gt;queue_draw</span><span class="sc">;</span>
    <span class="w">Gtk2</span><span class="w">-&gt;main_iteration</span> <span class="k">while</span> <span class="s">(</span> <span class="w">Gtk2</span><span class="w">-&gt;events_pending</span> <span class="s">)</span><span class="sc">;</span>

<span class="s">}</span>

<a name="add_default_buttons-"></a><span class="k">sub </span><span class="m">add_default_buttons</span> <span class="s">{</span>
    <span class="c"># We&#39;re going to show the following:</span>
    <span class="c"># cancel-button: obviously cancels the scan</span>
    <span class="c"># prefs-button: allows popup &#39;clamtk&#39; with no args, for settings.</span>
    <span class="c"># We don&#39;t even need translations for this.</span>
    <span class="i">$bottombar</span><span class="i">-&gt;add_button</span><span class="s">(</span> <span class="q">&#39;gtk-cancel&#39;</span><span class="cm">,</span>      <span class="i">HATE_GNOME_SHELL</span><span class="cm">,</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$bottombar</span><span class="i">-&gt;add_button</span><span class="s">(</span> <span class="q">&#39;gtk-preferences&#39;</span><span class="cm">,</span> <span class="i">DESTROY_GNOME_SHELL</span><span class="cm">,</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$bottombar</span><span class="i">-&gt;signal_connect</span><span class="s">(</span>
        <span class="w">response</span> <span class="cm">=&gt;</span> <span class="k">sub</span> <span class="s">{</span>
            <span class="k">my</span> <span class="s">(</span> <span class="i">$bar</span><span class="cm">,</span> <span class="i">$response</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$response</span> <span class="k">eq</span> <span class="q">&#39;cancel&#39;</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">cancel_scan</span><span class="s">(</span><span class="s">)</span><span class="sc">;</span>
                <span class="k">return</span> <span class="w">TRUE</span><span class="sc">;</span>
            <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$response</span> <span class="k">eq</span> <span class="q">&#39;help&#39;</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">system</span><span class="s">(</span> <span class="q">&#39;clamtk &amp;&#39;</span> <span class="s">)</span><span class="sc">;</span>
                <span class="k">return</span> <span class="w">FALSE</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">)</span><span class="sc">;</span>
<span class="s">}</span>

<a name="add_closing_buttons-"></a><span class="k">sub </span><span class="m">add_closing_buttons</span> <span class="s">{</span>
    <span class="i">$bottombar</span><span class="i">-&gt;add_button</span><span class="s">(</span> <span class="q">&#39;gtk-close&#39;</span><span class="cm">,</span> <span class="n">-7</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> !<span class="i">$dontshow</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$bottombar</span><span class="i">-&gt;add_button</span><span class="s">(</span> <span class="q">&#39;gtk-preferences&#39;</span><span class="cm">,</span> <span class="i">DESTROY_GNOME_SHELL</span><span class="cm">,</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="i">$bottombar</span><span class="i">-&gt;signal_connect</span><span class="s">(</span>
        <span class="w">response</span> <span class="cm">=&gt;</span> <span class="k">sub</span> <span class="s">{</span>
            <span class="k">my</span> <span class="s">(</span> <span class="i">$bar</span><span class="cm">,</span> <span class="i">$response</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$response</span> <span class="k">eq</span> <span class="q">&#39;close&#39;</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$window</span><span class="i">-&gt;destroy</span><span class="sc">;</span>
            <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$response</span> <span class="k">eq</span> <span class="q">&#39;help&#39;</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">system</span><span class="s">(</span> <span class="q">&#39;clamtk &amp;&#39;</span> <span class="s">)</span><span class="sc">;</span>
                <span class="k">return</span> <span class="w">FALSE</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="i">$bottombar</span><span class="i">-&gt;show_all</span><span class="sc">;</span>
<span class="s">}</span>

<a name="destroy_buttons-"></a><span class="k">sub </span><span class="m">destroy_buttons</span> <span class="s">{</span>
    <span class="k">for</span> <span class="k">my</span> <span class="i">$c</span> <span class="s">(</span> <span class="i">$bottombar</span><span class="i">-&gt;get_action_area</span><span class="i">-&gt;get_children</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$c</span><span class="i">-&gt;isa</span><span class="s">(</span> <span class="q">&#39;Gtk2::Button&#39;</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$c</span><span class="i">-&gt;destroy</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="k">return</span> <span class="w">TRUE</span><span class="sc">;</span>
<span class="s">}</span>

<span class="n">1</span><span class="sc">;</span>
<a name="EOF-"></a></pre>
</body>
</html>
