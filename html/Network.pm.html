<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by perltidy on Sun Mar  9 08:18:37 2014 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Network.pm</title>
<style type="text/css">
<!--
/* default style sheet generated by perltidy */
body {background: #FFFFFF; color: #000000}
pre { color: #000000; 
      background: #FFFFFF;
      font-family: courier;
    } 

.c  { color: #228B22;} /* comment */
.cm { color: #000000;} /* comma */
.co { color: #000000;} /* colon */
.h  { color: #CD5555; font-weight:bold;} /* here-doc-target */
.hh { color: #CD5555; font-style:italic;} /* here-doc-text */
.i  { color: #00688B;} /* identifier */
.j  { color: #CD5555; font-weight:bold;} /* label */
.k  { color: #8B008B; font-weight:bold;} /* keyword */
.m  { color: #FF0000; font-weight:bold;} /* subroutine */
.n  { color: #B452CD;} /* numeric */
.p  { color: #000000;} /* paren */
.pd { color: #228B22; font-style:italic;} /* pod-text */
.pu { color: #000000;} /* punctuation */
.q  { color: #CD5555;} /* quote */
.s  { color: #000000;} /* structure */
.sc { color: #000000;} /* semicolon */
.v  { color: #B452CD;} /* v-string */
.w  { color: #000000;} /* bareword */
-->
</style>
</head>
<body>
<a name="-top-"></a>
<h1>Network.pm</h1>
<hr />
<!-- contents of filename: Network.pm -->
<pre>
<span class="c"># ClamTk, copyright (C) 2004-2014 Dave M</span>
<span class="c">#</span>
<span class="c"># This file is part of ClamTk (http://code.google.com/p/clamtk/).</span>
<span class="c">#</span>
<span class="c"># ClamTk is free software; you can redistribute it and/or modify it</span>
<span class="c"># under the terms of either:</span>
<span class="c">#</span>
<span class="c"># a) the GNU General Public License as published by the Free Software</span>
<span class="c"># Foundation; either version 1, or (at your option) any later version, or</span>
<span class="c">#</span>
<span class="c"># b) the &quot;Artistic License&quot;.</span>
<a name="package-ClamTk::Network-"></a><span class="k">package </span><span class="i">ClamTk::Network</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">Glib</span> <span class="q">&#39;TRUE&#39;</span><span class="cm">,</span> <span class="q">&#39;FALSE&#39;</span><span class="sc">;</span>

<span class="c">#use strict;</span>
<span class="c">#use warnings;</span>
<span class="i">$|</span> = <span class="n">1</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">LWP::UserAgent</span><span class="sc">;</span>

<span class="k">use</span> <span class="w">POSIX</span> <span class="q">&#39;locale_h&#39;</span><span class="sc">;</span>
<span class="k">use</span> <span class="w">Locale::gettext</span><span class="sc">;</span>

<span class="k">my</span> <span class="i">$proxy_status_image</span><span class="sc">;</span>    <span class="c"># Gtk2::Image</span>
<span class="k">my</span> <span class="i">$infobar</span><span class="sc">;</span>               <span class="c"># Gtk2::InfoBar</span>

<a name="show_window-"></a><span class="k">sub </span><span class="m">show_window</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$eb</span> = <span class="w">Gtk2::EventBox</span><span class="w">-&gt;new</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$white</span> = <span class="w">Gtk2::Gdk::Color</span><span class="w">-&gt;new</span><span class="s">(</span> <span class="n">0xFFFF</span><span class="cm">,</span> <span class="n">0xFFFF</span><span class="cm">,</span> <span class="n">0xFFFF</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$eb</span><span class="i">-&gt;modify_bg</span><span class="s">(</span> <span class="q">&#39;normal&#39;</span><span class="cm">,</span> <span class="i">$white</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">#$eb-&gt;override_background_color( &#39;normal&#39;,</span>
    <span class="c">#    Gtk2::Gdk::RGBA-&gt;new( .93, .93, .93, .93 ),</span>
    <span class="c">#);</span>

    <span class="k">my</span> <span class="i">$box</span> = <span class="w">Gtk2::VBox</span><span class="w">-&gt;new</span><span class="s">(</span> <span class="w">FALSE</span><span class="cm">,</span> <span class="n">5</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$eb</span><span class="i">-&gt;add</span><span class="s">(</span> <span class="i">$box</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$grid</span> = <span class="w">Gtk2::Table</span><span class="w">-&gt;new</span><span class="s">(</span> <span class="n">6</span><span class="cm">,</span> <span class="n">3</span><span class="cm">,</span> <span class="w">FALSE</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$box</span><span class="i">-&gt;pack_start</span><span class="s">(</span> <span class="i">$grid</span><span class="cm">,</span> <span class="w">FALSE</span><span class="cm">,</span> <span class="w">FALSE</span><span class="cm">,</span> <span class="n">5</span> <span class="s">)</span><span class="sc">;</span>
    <span class="c">#$grid-&gt;set_column_spacing( 10 );</span>
    <span class="i">$grid</span><span class="i">-&gt;set_col_spacings</span><span class="s">(</span> <span class="n">5</span> <span class="s">)</span><span class="sc">;</span>
    <span class="c">#$grid-&gt;set_column_homogeneous( TRUE );</span>

    <span class="k">my</span> <span class="i">$none_button</span> = <span class="w">Gtk2::RadioButton</span><span class="w">-&gt;new_with_label_from_widget</span><span class="s">(</span> <span class="k">undef</span><span class="cm">,</span>
        <span class="i">_</span><span class="s">(</span> <span class="q">&#39;No proxy&#39;</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$grid</span><span class="i">-&gt;attach_defaults</span><span class="s">(</span> <span class="i">$none_button</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$none_button</span><span class="i">-&gt;can_focus</span><span class="s">(</span> <span class="w">FALSE</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$env_button</span>
        = <span class="w">Gtk2::RadioButton</span><span class="w">-&gt;new_with_label_from_widget</span><span class="s">(</span> <span class="i">$none_button</span><span class="cm">,</span>
        <span class="i">_</span><span class="s">(</span> <span class="q">&#39;Environment settings&#39;</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$grid</span><span class="i">-&gt;attach_defaults</span><span class="s">(</span> <span class="i">$env_button</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="n">2</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$env_button</span><span class="i">-&gt;can_focus</span><span class="s">(</span> <span class="w">FALSE</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$manual_button</span>
        = <span class="w">Gtk2::RadioButton</span><span class="w">-&gt;new_with_label_from_widget</span><span class="s">(</span> <span class="i">$none_button</span><span class="cm">,</span>
        <span class="i">_</span><span class="s">(</span> <span class="q">&#39;Set manually&#39;</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$grid</span><span class="i">-&gt;attach_defaults</span><span class="s">(</span> <span class="i">$manual_button</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="n">2</span><span class="cm">,</span> <span class="n">3</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$manual_button</span><span class="i">-&gt;can_focus</span><span class="s">(</span> <span class="w">FALSE</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># Proxy host information</span>
    <span class="k">my</span> <span class="i">$label</span> = <span class="w">Gtk2::Label</span><span class="w">-&gt;new</span><span class="s">(</span> <span class="i">_</span><span class="s">(</span> <span class="q">&#39;IP address or host&#39;</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$grid</span><span class="i">-&gt;attach_defaults</span><span class="s">(</span> <span class="i">$label</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="n">2</span><span class="cm">,</span> <span class="n">3</span><span class="cm">,</span> <span class="n">4</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c">#my $buffer = Gtk2::EntryBuffer-&gt;new( undef, -1 );</span>
    <span class="c">#$buffer-&gt;set_max_length( 63 );</span>
    <span class="c">#my $host_entry = Gtk2::Entry-&gt;new_with_buffer( $buffer );</span>
    <span class="k">my</span> <span class="i">$host_entry</span> = <span class="w">Gtk2::Entry</span><span class="w">-&gt;new_with_max_length</span><span class="s">(</span> <span class="n">63</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$grid</span><span class="i">-&gt;attach_defaults</span><span class="s">(</span> <span class="i">$host_entry</span><span class="cm">,</span> <span class="n">2</span><span class="cm">,</span> <span class="n">3</span><span class="cm">,</span> <span class="n">3</span><span class="cm">,</span> <span class="n">4</span> <span class="s">)</span><span class="sc">;</span>
    <span class="c">#$buffer-&gt;signal_connect(</span>
    <span class="c">#    &#39;inserted-text&#39; =&gt; sub {</span>
    <span class="c">#        my ( $entry, $position, $string ) = @_;</span>
    <span class="i">$host_entry</span><span class="i">-&gt;signal_connect</span><span class="s">(</span>
        <span class="q">&#39;insert-text&#39;</span> <span class="cm">=&gt;</span> <span class="k">sub</span> <span class="s">{</span>
            <span class="k">my</span> <span class="s">(</span> <span class="i">$widget</span><span class="cm">,</span> <span class="i">$string</span><span class="cm">,</span> <span class="i">$position</span> <span class="s">)</span> = <span class="i">@_</span><span class="sc">;</span>

            <span class="c"># http://www.ietf.org/rfc/rfc1738.txt</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$string</span> !~ <span class="q">m#[\w\.\-\+/:\@\#]#</span> <span class="s">)</span> <span class="s">{</span>
                <span class="c">#$buffer-&gt;delete_text( $position, 1 );</span>
                <span class="i">$host_entry</span><span class="i">-&gt;signal_stop_emission_by_name</span><span class="s">(</span> <span class="q">&#39;insert-text&#39;</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">return</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="c"># Proxy port information</span>
    <span class="i">$label</span> = <span class="w">Gtk2::Label</span><span class="w">-&gt;new</span><span class="s">(</span> <span class="i">_</span><span class="s">(</span> <span class="q">&#39;Port&#39;</span> <span class="s">)</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$grid</span><span class="i">-&gt;attach_defaults</span><span class="s">(</span> <span class="i">$label</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="n">2</span><span class="cm">,</span> <span class="n">4</span><span class="cm">,</span> <span class="n">5</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$port_spin</span> = <span class="w">Gtk2::SpinButton</span><span class="w">-&gt;new_with_range</span><span class="s">(</span> <span class="n">1</span><span class="cm">,</span> <span class="n">65535</span><span class="cm">,</span> <span class="n">1</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$port_spin</span><span class="i">-&gt;set_value</span><span class="s">(</span> <span class="n">8080</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$grid</span><span class="i">-&gt;attach_defaults</span><span class="s">(</span> <span class="i">$port_spin</span><span class="cm">,</span> <span class="n">2</span><span class="cm">,</span> <span class="n">3</span><span class="cm">,</span> <span class="n">4</span><span class="cm">,</span> <span class="n">5</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># Signals for radiobuttons</span>
    <span class="i">$none_button</span><span class="i">-&gt;signal_connect</span><span class="s">(</span>
        <span class="w">toggled</span> <span class="cm">=&gt;</span> <span class="k">sub</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$none_button</span><span class="i">-&gt;get_active</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$host_entry</span><span class="i">-&gt;set_sensitive</span><span class="s">(</span> <span class="w">FALSE</span> <span class="s">)</span><span class="sc">;</span>
                <span class="i">$port_spin</span><span class="i">-&gt;set_sensitive</span><span class="s">(</span> <span class="w">FALSE</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="i">$env_button</span><span class="i">-&gt;signal_connect</span><span class="s">(</span>
        <span class="w">toggled</span> <span class="cm">=&gt;</span> <span class="k">sub</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$env_button</span><span class="i">-&gt;get_active</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$host_entry</span><span class="i">-&gt;set_sensitive</span><span class="s">(</span> <span class="w">FALSE</span> <span class="s">)</span><span class="sc">;</span>
                <span class="i">$port_spin</span><span class="i">-&gt;set_sensitive</span><span class="s">(</span> <span class="w">FALSE</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="i">$manual_button</span><span class="i">-&gt;signal_connect</span><span class="s">(</span>
        <span class="w">toggled</span> <span class="cm">=&gt;</span> <span class="k">sub</span> <span class="s">{</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$manual_button</span><span class="i">-&gt;get_active</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$host_entry</span><span class="i">-&gt;set_sensitive</span><span class="s">(</span> <span class="w">TRUE</span> <span class="s">)</span><span class="sc">;</span>
                <span class="i">$port_spin</span><span class="i">-&gt;set_sensitive</span><span class="s">(</span> <span class="w">TRUE</span> <span class="s">)</span><span class="sc">;</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="k">my</span> <span class="i">$apply_button</span> = <span class="w">Gtk2::Button</span><span class="w">-&gt;new_from_stock</span><span class="s">(</span> <span class="q">&#39;gtk-apply&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$grid</span><span class="i">-&gt;attach_defaults</span><span class="s">(</span> <span class="i">$apply_button</span><span class="cm">,</span> <span class="n">0</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="n">5</span><span class="cm">,</span> <span class="n">6</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$proxy_status_image</span> = <span class="w">Gtk2::ToolButton</span><span class="w">-&gt;new_from_stock</span><span class="s">(</span> <span class="q">&#39;gtk-yes&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$grid</span><span class="i">-&gt;attach_defaults</span><span class="s">(</span> <span class="i">$proxy_status_image</span><span class="cm">,</span> <span class="n">1</span><span class="cm">,</span> <span class="n">2</span><span class="cm">,</span> <span class="n">5</span><span class="cm">,</span> <span class="n">6</span> <span class="s">)</span><span class="sc">;</span>

    <span class="c"># What does the user have set?</span>
    <span class="c"># 0 = no proxy, 1 = env_proxy and 2 = manual proxy</span>
    <span class="k">my</span> <span class="i">$setting</span> = <span class="w">ClamTk::Prefs</span><span class="w">-&gt;get_preference</span><span class="s">(</span> <span class="q">&#39;HTTPProxy&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$host_entry</span><span class="i">-&gt;set_sensitive</span><span class="s">(</span> <span class="w">FALSE</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$port_spin</span><span class="i">-&gt;set_sensitive</span><span class="s">(</span> <span class="w">FALSE</span> <span class="s">)</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> !<span class="i">$setting</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$none_button</span><span class="i">-&gt;set_active</span><span class="s">(</span> <span class="w">TRUE</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$setting</span> == <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$env_button</span><span class="i">-&gt;set_active</span><span class="s">(</span> <span class="w">TRUE</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$setting</span> == <span class="n">2</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$manual_button</span><span class="i">-&gt;set_active</span><span class="s">(</span> <span class="w">TRUE</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$host_entry</span><span class="i">-&gt;set_sensitive</span><span class="s">(</span> <span class="w">TRUE</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$port_spin</span><span class="i">-&gt;set_sensitive</span><span class="s">(</span> <span class="w">TRUE</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>

    <span class="k">my</span> <span class="i">$path</span> = <span class="w">ClamTk::App</span><span class="w">-&gt;get_path</span><span class="s">(</span> <span class="q">&#39;db&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$path</span> .= <span class="q">&#39;/local.conf&#39;</span><span class="sc">;</span>

    <span class="k">if</span> <span class="s">(</span> <span class="k">-f</span> <span class="i">$path</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="k">open</span><span class="s">(</span> <span class="k">my</span> <span class="i">$FH</span><span class="cm">,</span> <span class="q">&#39;&lt;&#39;</span><span class="cm">,</span> <span class="i">$path</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="k">while</span> <span class="s">(</span> <span class="q">&lt;$FH&gt;</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">chomp</span><span class="sc">;</span>
                <span class="k">my</span> <span class="i">$set</span><span class="sc">;</span>
                <span class="k">if</span> <span class="s">(</span> <span class="q">/HTTPProxyServer\s+(.*?)$/</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="i">$set</span> = <span class="i">$1</span><span class="sc">;</span>
                    <span class="k">if</span> <span class="s">(</span> <span class="i">$set</span> !~ <span class="q">m#://#</span> <span class="s">)</span> <span class="s">{</span>
                        <span class="i">$set</span> = <span class="q">&#39;http://&#39;</span> . <span class="i">$set</span><span class="sc">;</span>
                    <span class="s">}</span>
                    <span class="i">$host_entry</span><span class="i">-&gt;set_text</span><span class="s">(</span> <span class="i">$set</span> <span class="s">)</span><span class="sc">;</span>
                    <span class="k">if</span> <span class="s">(</span>  !<span class="i">$setting</span>
                        || <span class="i">$setting</span> == <span class="n">1</span> <span class="s">)</span>
                    <span class="s">{</span>
                        <span class="i">$host_entry</span><span class="i">-&gt;set_sensitive</span><span class="s">(</span> <span class="w">FALSE</span> <span class="s">)</span><span class="sc">;</span>
                    <span class="s">}</span>
                <span class="s">}</span>
                <span class="k">if</span> <span class="s">(</span> <span class="q">/HTTPProxyPort\s+(.*?)$/</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="i">$port_spin</span><span class="i">-&gt;set_value</span><span class="s">(</span> <span class="i">$1</span> <span class="s">)</span><span class="sc">;</span>
                    <span class="k">if</span> <span class="s">(</span>  !<span class="i">$setting</span>
                        || <span class="i">$setting</span> == <span class="n">1</span> <span class="s">)</span>
                    <span class="s">{</span>
                        <span class="i">$port_spin</span><span class="i">-&gt;set_sensitive</span><span class="s">(</span> <span class="w">FALSE</span> <span class="s">)</span><span class="sc">;</span>
                    <span class="s">}</span>
                <span class="s">}</span>
            <span class="s">}</span>
            <span class="k">close</span><span class="s">(</span> <span class="i">$FH</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>

    <span class="i">$infobar</span> = <span class="w">Gtk2::InfoBar</span><span class="w">-&gt;new</span><span class="sc">;</span>
    <span class="i">$box</span><span class="i">-&gt;pack_start</span><span class="s">(</span> <span class="i">$infobar</span><span class="cm">,</span> <span class="w">FALSE</span><span class="cm">,</span> <span class="w">FALSE</span><span class="cm">,</span> <span class="n">5</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$info_label</span> = <span class="w">Gtk2::Label</span><span class="w">-&gt;new</span><span class="s">(</span> <span class="q">&#39; &#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$info_label</span><span class="i">-&gt;set_alignment</span><span class="s">(</span> <span class="n">0.0</span><span class="cm">,</span> <span class="n">0.5</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$infobar</span><span class="i">-&gt;get_content_area</span><span class="i">-&gt;add</span><span class="s">(</span> <span class="i">$info_label</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$infobar</span><span class="i">-&gt;set_message_type</span><span class="s">(</span> <span class="q">&#39;other&#39;</span> <span class="s">)</span><span class="sc">;</span>

    <span class="i">$apply_button</span><span class="i">-&gt;signal_connect</span><span class="s">(</span>
        <span class="w">clicked</span> <span class="cm">=&gt;</span> <span class="k">sub</span> <span class="s">{</span>
            <span class="k">my</span> <span class="i">$choice</span><span class="sc">;</span>
            <span class="k">if</span> <span class="s">(</span> <span class="i">$env_button</span><span class="i">-&gt;get_active</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$choice</span> = <span class="n">1</span><span class="sc">;</span>
            <span class="s">}</span> <span class="k">elsif</span> <span class="s">(</span> <span class="i">$manual_button</span><span class="i">-&gt;get_active</span> <span class="s">)</span> <span class="s">{</span>
                <span class="i">$choice</span> = <span class="n">2</span><span class="sc">;</span>
            <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
                <span class="i">$choice</span> = <span class="n">0</span><span class="sc">;</span>
            <span class="s">}</span>
            <span class="k">if</span> <span class="s">(</span>   <span class="i">$choice</span> == <span class="n">0</span>
                || <span class="i">$choice</span> == <span class="n">1</span> <span class="s">)</span>
            <span class="s">{</span>
                <span class="k">if</span> <span class="s">(</span> <span class="w">ClamTk::Prefs</span><span class="w">-&gt;set_preference</span><span class="s">(</span> <span class="q">&#39;HTTPProxy&#39;</span><span class="cm">,</span> <span class="i">$choice</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="i">proxy_non_block_status</span><span class="s">(</span> <span class="q">&#39;yes&#39;</span> <span class="s">)</span><span class="sc">;</span>
                <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
                    <span class="i">proxy_non_block_status</span><span class="s">(</span> <span class="q">&#39;no&#39;</span> <span class="s">)</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>

            <span class="k">if</span> <span class="s">(</span> <span class="i">$manual_button</span><span class="i">-&gt;get_active</span> <span class="s">)</span> <span class="s">{</span>
                <span class="k">if</span> <span class="s">(</span> <span class="k">length</span><span class="s">(</span> <span class="i">$host_entry</span><span class="i">-&gt;get_text</span> <span class="s">)</span> &lt; <span class="n">1</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="i">$none_button</span><span class="i">-&gt;set_active</span><span class="s">(</span> <span class="w">TRUE</span> <span class="s">)</span><span class="sc">;</span>
                    <span class="k">return</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="k">my</span> <span class="i">$ip</span> = <span class="i">$host_entry</span><span class="i">-&gt;get_text</span><span class="sc">;</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$ip</span> !~ <span class="q">m#://#</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="i">$ip</span> = <span class="q">&#39;http://&#39;</span> . <span class="i">$ip</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="k">my</span> <span class="i">$port</span> = <span class="i">$port_spin</span><span class="i">-&gt;get_value_as_int</span><span class="sc">;</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$port</span> =~ <span class="q">/^(\d+)$/</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="i">$port</span> = <span class="i">$1</span><span class="sc">;</span>
                <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
                    <span class="i">$port</span> = <span class="n">8080</span><span class="sc">;</span>
                <span class="s">}</span>

                <span class="c"># Hate to pull in LWP::UserAgent just for this,</span>
                <span class="c"># but we need to sanity check it before they get</span>
                <span class="c"># to using it in the first place</span>
                <span class="k">eval</span> <span class="s">{</span>
                    <span class="k">my</span> <span class="i">$ua</span> = <span class="w">LWP::UserAgent</span><span class="w">-&gt;new</span><span class="sc">;</span>
                    <span class="i">$ua</span><span class="i">-&gt;proxy</span><span class="s">(</span> <span class="w">http</span> <span class="cm">=&gt;</span> <span class="q">&quot;$ip:$port&quot;</span> <span class="s">)</span><span class="sc">;</span>
                <span class="s">}</span><span class="sc">;</span>
                <span class="k">if</span> <span class="s">(</span> <span class="i">$@</span> <span class="s">)</span> <span class="s">{</span>
                    <span class="i">proxy_non_block_status</span><span class="s">(</span> <span class="q">&#39;no&#39;</span> <span class="s">)</span><span class="sc">;</span>
                    <span class="k">return</span><span class="sc">;</span>
                <span class="s">}</span>
                <span class="k">if</span> <span class="s">(</span>   <span class="w">ClamTk::Prefs</span><span class="w">-&gt;set_preference</span><span class="s">(</span> <span class="q">&#39;HTTPProxy&#39;</span><span class="cm">,</span> <span class="i">$choice</span> <span class="s">)</span>
                    &amp;&amp; <span class="w">ClamTk::Prefs</span><span class="w">-&gt;set_proxy</span><span class="s">(</span> <span class="i">$ip</span><span class="cm">,</span> <span class="i">$port</span> <span class="s">)</span> <span class="s">)</span>
                <span class="s">{</span>
                    <span class="i">proxy_non_block_status</span><span class="s">(</span> <span class="q">&#39;yes&#39;</span> <span class="s">)</span><span class="sc">;</span>
                    <span class="i">$host_entry</span><span class="i">-&gt;set_text</span><span class="s">(</span> <span class="i">$ip</span> <span class="s">)</span><span class="sc">;</span>
                    <span class="i">$port_spin</span><span class="i">-&gt;set_value</span><span class="s">(</span> <span class="i">$port</span> <span class="s">)</span><span class="sc">;</span>
                <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
                    <span class="i">proxy_non_block_status</span><span class="s">(</span> <span class="q">&#39;no&#39;</span> <span class="s">)</span><span class="sc">;</span>
                    <span class="i">$host_entry</span><span class="i">-&gt;set_text</span><span class="s">(</span> <span class="i">$ip</span> <span class="s">)</span><span class="sc">;</span>
                    <span class="i">$port_spin</span><span class="i">-&gt;set_value</span><span class="s">(</span> <span class="i">$port</span> <span class="s">)</span><span class="sc">;</span>
                <span class="s">}</span>
            <span class="s">}</span>
        <span class="s">}</span>
    <span class="s">)</span><span class="sc">;</span>

    <span class="i">$eb</span><span class="i">-&gt;show_all</span><span class="sc">;</span>
    <span class="i">$proxy_status_image</span><span class="i">-&gt;hide</span><span class="sc">;</span>
    <span class="k">return</span> <span class="i">$eb</span><span class="sc">;</span>
<span class="s">}</span>

<a name="set_infobar_text-"></a><span class="k">sub </span><span class="m">set_infobar_text</span> <span class="s">{</span>
    <span class="k">my</span> <span class="i">$text</span> = <span class="k">shift</span><span class="sc">;</span>

    <span class="w">Gtk2</span><span class="w">-&gt;main_iteration</span> <span class="k">while</span> <span class="w">Gtk2</span><span class="w">-&gt;events_pending</span><span class="sc">;</span>
    <span class="k">for</span> <span class="k">my</span> <span class="i">$child</span> <span class="s">(</span> <span class="i">$infobar</span><span class="i">-&gt;get_content_area</span><span class="i">-&gt;get_children</span> <span class="s">)</span> <span class="s">{</span>
        <span class="k">if</span> <span class="s">(</span> <span class="i">$child</span><span class="i">-&gt;isa</span><span class="s">(</span> <span class="q">&#39;Gtk2::Label&#39;</span> <span class="s">)</span> <span class="s">)</span> <span class="s">{</span>
            <span class="i">$child</span><span class="i">-&gt;set_text</span><span class="s">(</span> <span class="i">$text</span> <span class="s">)</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">}</span>
    <span class="w">Gtk2</span><span class="w">-&gt;main_iteration</span> <span class="k">while</span> <span class="w">Gtk2</span><span class="w">-&gt;events_pending</span><span class="sc">;</span>
<span class="s">}</span>

<a name="proxy_non_block_status-"></a><span class="k">sub </span><span class="m">proxy_non_block_status</span> <span class="s">{</span>
    <span class="c"># This is a non-blocking way to show success or failure</span>
    <span class="c"># in the proxy configuration dialog.</span>
    <span class="c"># I think muppet came up with this.</span>
    <span class="k">my</span> <span class="i">$status</span>  = <span class="k">shift</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$message</span> = <span class="q">&#39;&#39;</span><span class="sc">;</span>
    <span class="k">if</span> <span class="s">(</span> <span class="i">$status</span> <span class="k">eq</span> <span class="q">&#39;yes&#39;</span> <span class="s">)</span> <span class="s">{</span>
        <span class="i">$proxy_status_image</span><span class="i">-&gt;set_stock_id</span><span class="s">(</span> <span class="q">&#39;gtk-yes&#39;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$message</span> = <span class="i">_</span><span class="s">(</span> <span class="q">&#39;Settings saved&#39;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$infobar</span><span class="i">-&gt;set_message_type</span><span class="s">(</span> <span class="q">&#39;info&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span> <span class="k">else</span> <span class="s">{</span>
        <span class="i">$proxy_status_image</span><span class="i">-&gt;set_stock_id</span><span class="s">(</span> <span class="q">&#39;gtk-no&#39;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$message</span> = <span class="i">_</span><span class="s">(</span> <span class="q">&#39;Error&#39;</span> <span class="s">)</span><span class="sc">;</span>
        <span class="i">$infobar</span><span class="i">-&gt;set_message_type</span><span class="s">(</span> <span class="q">&#39;error&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="s">}</span>
    <span class="i">set_infobar_text</span><span class="s">(</span> <span class="i">$message</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$proxy_status_image</span><span class="i">-&gt;show</span><span class="sc">;</span>
    <span class="k">my</span> <span class="i">$loop</span> = <span class="w">Glib::MainLoop</span><span class="w">-&gt;new</span><span class="sc">;</span>
    <span class="w">Glib::Timeout</span><span class="w">-&gt;add</span><span class="s">(</span>
        <span class="n">1000</span><span class="cm">,</span>
        <span class="k">sub</span> <span class="s">{</span>
            <span class="i">$loop</span><span class="i">-&gt;quit</span><span class="sc">;</span>
            <span class="w">FALSE</span><span class="sc">;</span>
        <span class="s">}</span>
    <span class="s">)</span><span class="sc">;</span>
    <span class="i">$loop</span><span class="i">-&gt;run</span><span class="sc">;</span>
    <span class="i">set_infobar_text</span><span class="s">(</span> <span class="q">&#39;&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="i">$proxy_status_image</span><span class="i">-&gt;hide</span><span class="sc">;</span>
    <span class="i">$infobar</span><span class="i">-&gt;set_message_type</span><span class="s">(</span> <span class="q">&#39;other&#39;</span> <span class="s">)</span><span class="sc">;</span>
    <span class="k">return</span><span class="sc">;</span>
<span class="s">}</span>

<span class="n">1</span><span class="sc">;</span>
<a name="EOF-"></a></pre>
</body>
</html>
